{% extends "base.html" %}

{% block title %}Alert {{ alert.id[:8] }} - {{ app_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Alert Details</h1>
    <a href="{{ url_for('asp_alerts.alerts_active') }}" class="btn btn-secondary">Back to Active</a>
</div>

<div class="alert-detail-layout">
    <!-- Left Column: Alert Information -->
    <div class="alert-detail-main">
        <div class="alert-detail-card">
            <div class="alert-header">
                <div class="alert-id">
                    <span class="badge badge-{{ alert.severity }}">{{ alert.severity.upper() }}</span>
                    <span class="badge badge-status-{{ alert.status.value }}">{{ alert.status.value.upper() }}</span>
                    <span class="alert-type">{{ alert.alert_type.value }}</span>
                </div>
                <div class="alert-title">{{ alert.title or 'Untitled Alert' }}</div>
            </div>

            <div class="alert-body">
                <div class="info-section">
                    <h3>Patient Information</h3>
                    <dl>
                        <dt>Name</dt>
                        <dd>{{ alert.patient_name or 'Unknown' }}</dd>
                        <dt>MRN</dt>
                        <dd>{{ alert.patient_mrn or 'Unknown' }}</dd>
                        <dt>Patient ID</dt>
                        <dd style="font-size: 0.75rem; word-break: break-all;">{{ alert.patient_id or 'Unknown' }}</dd>
                    </dl>
                </div>

                <div class="info-section">
                    <h3>Alert Timeline</h3>
                    <dl>
                        <dt>Alert ID</dt>
                        <dd style="font-size: 0.75rem;">{{ alert.id }}</dd>
                        <dt>Created</dt>
                        <dd>
                            <span class="time-relative" data-timestamp="{{ alert.created_at.isoformat() if alert.created_at else '' }}">
                                {{ alert.created_at.strftime('%Y-%m-%d %H:%M:%S') if alert.created_at else '-' }}
                            </span>
                        </dd>
                        <dt>Sent</dt>
                        <dd>{{ alert.sent_at.strftime('%Y-%m-%d %H:%M:%S') if alert.sent_at else 'Not sent' }}</dd>
                        {% if alert.acknowledged_at %}
                        <dt>Acknowledged</dt>
                        <dd>{{ alert.acknowledged_at.strftime('%Y-%m-%d %H:%M:%S') }} by {{ alert.acknowledged_by or 'Unknown' }}</dd>
                        {% endif %}
                        {% if alert.status.value == 'snoozed' and alert.snoozed_until %}
                        <dt>Snoozed Until</dt>
                        <dd>{{ alert.snoozed_until.strftime('%Y-%m-%d %H:%M:%S') }}</dd>
                        {% endif %}
                        {% if alert.resolved_at %}
                        <dt>Resolved</dt>
                        <dd>{{ alert.resolved_at.strftime('%Y-%m-%d %H:%M:%S') }} by {{ alert.resolved_by or 'Unknown' }}</dd>
                        {% endif %}
                    </dl>
                </div>

                {% if alert.summary %}
                <div class="info-section">
                    <h3>Summary</h3>
                    <p>{{ alert.summary }}</p>
                </div>
                {% endif %}

                {% if alert.content %}
                <div class="info-section">
                    <h3>Clinical Details</h3>
                    <dl>
                        {% for key, value in alert.content.items() %}
                        <dt>{{ key.replace('_', ' ').title() }}</dt>
                        <dd>
                            {% if key == 'coverage_status' %}
                                <span class="badge badge-coverage-{{ value|lower }}">{{ value|upper }}</span>
                            {% else %}
                                {{ value }}
                            {% endif %}
                        </dd>
                        {% endfor %}
                    </dl>
                </div>
                {% endif %}

                {% if alert.notes %}
                <div class="info-section">
                    <h3>Notes</h3>
                    <pre class="notes-content">{{ alert.notes }}</pre>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Right Column: Actions -->
    <div class="alert-detail-sidebar">
        {% if alert.status.value != 'resolved' %}
        <div class="action-card">
            <h3>Quick Actions</h3>
            <div class="action-buttons-vertical">
                {% if alert.status.value not in ('acknowledged',) %}
                <form action="{{ url_for('api.acknowledge_alert', alert_id=alert.id) }}" method="post">
                    <button type="submit" class="btn btn-primary btn-block">Acknowledge</button>
                </form>
                {% else %}
                <button class="btn btn-primary btn-block" disabled>Acknowledged</button>
                {% endif %}

                <form action="{{ url_for('api.snooze_alert', alert_id=alert.id) }}" method="post">
                    <input type="hidden" name="hours" value="4">
                    <button type="submit" class="btn btn-secondary btn-block">Snooze 4 Hours</button>
                </form>
            </div>
        </div>

        {% if alert.alert_type.value == 'bacteremia' and alert.source_id %}
        <div class="action-card">
            <h3>Clinical Data</h3>
            <div class="action-buttons-vertical">
                <a href="{{ url_for('asp_alerts.culture_detail', culture_id=alert.source_id) }}" class="btn btn-teal btn-block">View Culture Results</a>
                {% if alert.patient_id %}
                <a href="{{ url_for('asp_alerts.patient_medications', patient_id=alert.patient_id) }}" class="btn btn-teal btn-block">View Medications</a>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <div class="action-card">
            <h3>Resolve Alert</h3>
            <form action="{{ url_for('api.resolve_alert', alert_id=alert.id) }}" method="post" class="resolve-form">
                <div class="form-group">
                    <label for="resolution_reason">Resolution Reason</label>
                    <select name="resolution_reason" id="resolution_reason" class="form-select" required>
                        <option value="">-- Select --</option>
                        {% for value, display in resolution_reasons %}
                        <option value="{{ value }}">{{ display }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="notes">Notes (optional)</label>
                    <textarea name="notes" id="notes" rows="3" class="form-textarea" placeholder="Add details..."></textarea>
                </div>

                <button type="submit" class="btn btn-success btn-block">Resolve Alert</button>
            </form>
        </div>

        <div class="action-card">
            <h3>Add Note</h3>
            <form action="{{ url_for('api.add_note', alert_id=alert.id) }}" method="post">
                <div class="form-group">
                    <textarea name="note" rows="2" class="form-textarea" placeholder="Enter a note..."></textarea>
                </div>
                <button type="submit" class="btn btn-block">Add Note</button>
            </form>
        </div>
        {% else %}
        <div class="action-card resolved-card">
            <h3>Resolution Details</h3>
            <dl class="resolution-dl">
                <dt>Resolved By</dt>
                <dd>{{ alert.resolved_by or 'Unknown' }}</dd>
                <dt>Resolved At</dt>
                <dd>{{ alert.resolved_at.strftime('%Y-%m-%d %H:%M') if alert.resolved_at else '-' }}</dd>
                {% if alert.resolution_reason %}
                <dt>Reason</dt>
                <dd>{{ ResolutionReason.display_name(alert.resolution_reason) }}</dd>
                {% endif %}
                {% if alert.notes %}
                <dt>Notes</dt>
                <dd><pre class="notes-content-small">{{ alert.notes }}</pre></dd>
                {% endif %}
            </dl>
        </div>
        {% endif %}
    </div>
</div>

{% if audit_log %}
<div class="audit-section">
    <h3>Audit Log</h3>
    <table class="audit-table">
        <thead>
            <tr>
                <th>Timestamp</th>
                <th>Action</th>
                <th>User</th>
                <th>Details</th>
            </tr>
        </thead>
        <tbody>
            {% for entry in audit_log %}
            <tr>
                <td>{{ entry.performed_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                <td>{{ entry.action.value }}</td>
                <td>{{ entry.performed_by or 'System' }}</td>
                <td>{{ entry.details or '-' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}
{% endblock %}
