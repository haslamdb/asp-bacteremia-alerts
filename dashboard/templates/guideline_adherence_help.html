{% extends "base.html" %}

{% block title %}Guideline Adherence Help - {{ app_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Guideline Adherence - Help</h1>
    <a href="{{ url_for('guideline_adherence.dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
</div>

<div class="help-content">
    <div class="help-card">
        <h2>Overview</h2>
        <p>The Guideline Adherence module provides <strong>real-time monitoring</strong> of evidence-based clinical
           guideline bundles. It generates <strong>GUIDELINE_DEVIATION alerts</strong> when bundle elements are not
           completed within their time windows, and tracks <strong>aggregate compliance metrics</strong> for
           quality improvement and Joint Commission (JC) reporting.</p>
    </div>

    <div class="help-card">
        <h2>Why Separate from Antibiotic Indications?</h2>
        <table class="help-table">
            <thead>
                <tr>
                    <th>Aspect</th>
                    <th>Antibiotic Indications</th>
                    <th>Guideline Adherence</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Question</strong></td>
                    <td>"Is this order justified?"</td>
                    <td>"Did we follow the full pathway?"</td>
                </tr>
                <tr>
                    <td><strong>Timing</strong></td>
                    <td>Real-time (per order)</td>
                    <td>Real-time monitoring with time windows</td>
                </tr>
                <tr>
                    <td><strong>Scope</strong></td>
                    <td>Antibiotic orders only</td>
                    <td>Full care bundle (cultures, labs, imaging, consults, antibiotics)</td>
                </tr>
                <tr>
                    <td><strong>Alert Trigger</strong></td>
                    <td>No documented indication</td>
                    <td>Bundle element not completed within time window</td>
                </tr>
                <tr>
                    <td><strong>Output</strong></td>
                    <td>ASP alert for review</td>
                    <td>ASP alert + compliance metrics dashboard</td>
                </tr>
                <tr>
                    <td><strong>Audience</strong></td>
                    <td>Pharmacist, ordering provider</td>
                    <td>ASP team, QI, JC surveyors</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="help-card">
        <h2>How It Works</h2>
        <div class="workflow">
            <div class="workflow-step">
                <div class="step-number">1</div>
                <div class="step-content">
                    <h4>Bundle Triggered</h4>
                    <p>Patient identified with qualifying diagnosis (e.g., sepsis ICD-10 codes A41.x, R65.2x)</p>
                </div>
            </div>
            <div class="workflow-step">
                <div class="step-number">2</div>
                <div class="step-content">
                    <h4>Elements Monitored</h4>
                    <p>Each bundle element is tracked against its time window (e.g., antibiotics within 1 hour)</p>
                </div>
            </div>
            <div class="workflow-step">
                <div class="step-number">3</div>
                <div class="step-content">
                    <h4>Alert if Not Met</h4>
                    <p>When time window expires without completion, a GUIDELINE_DEVIATION alert is created in ASP Alerts</p>
                </div>
            </div>
            <div class="workflow-step">
                <div class="step-number">4</div>
                <div class="step-content">
                    <h4>Review & Resolve</h4>
                    <p>ASP team reviews alert, documents action, resolves in ASP Alerts queue</p>
                </div>
            </div>
        </div>
    </div>

    <div class="help-card">
        <h2>Available Guidelines</h2>
        <table class="help-table">
            <thead>
                <tr>
                    <th>Guideline</th>
                    <th>Elements</th>
                    <th>Key Metrics</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Pediatric Sepsis</strong></td>
                    <td>6</td>
                    <td>Blood culture, lactate, ABX &le;1h, fluids, reassessment</td>
                </tr>
                <tr>
                    <td><strong>Pediatric CAP</strong></td>
                    <td>6</td>
                    <td>CXR, SpO2, empiric choice, duration &le;7d</td>
                </tr>
                <tr>
                    <td><strong>Febrile Neutropenia</strong></td>
                    <td>6</td>
                    <td>Cultures, ABX &le;1h, risk stratification</td>
                </tr>
                <tr>
                    <td><strong>Surgical Prophylaxis</strong></td>
                    <td>5</td>
                    <td>Agent selection, timing &le;60min, duration &le;24h</td>
                </tr>
                <tr>
                    <td><strong>Pediatric UTI</strong></td>
                    <td>7</td>
                    <td>UA, culture, empiric choice, imaging</td>
                </tr>
                <tr>
                    <td><strong>SSTI/Cellulitis</strong></td>
                    <td>6</td>
                    <td>Margins marked, MRSA coverage, I&D if needed</td>
                </tr>
                <tr>
                    <td><strong>Febrile Infant (AAP 2021)</strong></td>
                    <td>12</td>
                    <td>UA, blood cx, inflammatory markers, LP (age-stratified), HSV consideration</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="help-card">
        <h2>Sepsis Bundle Details (CMS SEP-1)</h2>
        <p>The Pediatric Sepsis Bundle is based on Surviving Sepsis Campaign guidelines:</p>
        <table class="help-table">
            <thead>
                <tr>
                    <th>Element</th>
                    <th>Time Window</th>
                    <th>Data Source</th>
                    <th>Required</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Blood culture obtained</td>
                    <td>1 hour</td>
                    <td>Lab orders (LOINC 600-7)</td>
                    <td>Yes</td>
                </tr>
                <tr>
                    <td>Lactate measured</td>
                    <td>3 hours</td>
                    <td>Lab results (LOINC 2524-7)</td>
                    <td>Yes</td>
                </tr>
                <tr>
                    <td>Antibiotics within 1h</td>
                    <td>1 hour</td>
                    <td>Medication Administration</td>
                    <td>Yes</td>
                </tr>
                <tr>
                    <td>Fluid bolus (if shock)</td>
                    <td>1 hour</td>
                    <td>Medication Administration</td>
                    <td>Conditional</td>
                </tr>
                <tr>
                    <td>Repeat lactate if &gt;2</td>
                    <td>6 hours</td>
                    <td>Lab results</td>
                    <td>Conditional</td>
                </tr>
                <tr>
                    <td>48h reassessment</td>
                    <td>72 hours</td>
                    <td>Clinical notes</td>
                    <td>Yes</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="help-card">
        <h2>Febrile Infant Bundle Details (AAP 2021)</h2>
        <p>The Febrile Infant Bundle implements the AAP Clinical Practice Guideline for well-appearing febrile infants 8-60 days old:</p>
        <table class="help-table">
            <thead>
                <tr>
                    <th>Age Group</th>
                    <th>LP Required</th>
                    <th>Antibiotics</th>
                    <th>Disposition</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>8-21 days</td>
                    <td>Yes (all)</td>
                    <td>Yes - parenteral</td>
                    <td>Admit all</td>
                </tr>
                <tr>
                    <td>22-28 days, IMs abnormal</td>
                    <td>Yes</td>
                    <td>Yes - parenteral</td>
                    <td>Admit</td>
                </tr>
                <tr>
                    <td>22-28 days, IMs normal</td>
                    <td>Consider</td>
                    <td>Consider</td>
                    <td>Home with close f/u acceptable</td>
                </tr>
                <tr>
                    <td>29-60 days, IMs abnormal</td>
                    <td>Consider</td>
                    <td>Yes</td>
                    <td>Varies</td>
                </tr>
                <tr>
                    <td>29-60 days, IMs normal</td>
                    <td>Not required</td>
                    <td>If UTI only</td>
                    <td>Home observation acceptable</td>
                </tr>
            </tbody>
        </table>
        <p><strong>Inflammatory Marker Thresholds (Abnormal):</strong></p>
        <ul>
            <li>Procalcitonin &gt; 0.5 ng/mL</li>
            <li>ANC &gt; 4,000/&mu;L</li>
            <li>CRP &gt; 2.0 mg/dL</li>
        </ul>
        <p><strong>HSV Consideration:</strong> Required for infants 8-28 days. Consider acyclovir if maternal HSV history, vesicular rash, seizures, or CSF pleocytosis.</p>
    </div>

    <div class="help-card">
        <h2>Running the Monitor</h2>
        <h3>CLI Commands</h3>
        <pre class="code-block">
# Run monitor once (check all active episodes)
cd /home/david/projects/aegis/guideline-adherence
python -m src.runner --once

# Run for specific bundle only
python -m src.runner --once --bundle sepsis_peds_2024

# Dry run (no alerts created)
python -m src.runner --once --dry-run --verbose

# Run as daemon (every 15 minutes)
python -m src.runner --daemon --interval 15</pre>

        <h3>Cron Setup</h3>
        <pre class="code-block">
# Add to crontab for automatic monitoring every 15 minutes
*/15 * * * * cd /home/david/projects/aegis/guideline-adherence && \
    python -m src.runner --once >> /var/log/aegis/guideline-adherence.log 2>&1</pre>
    </div>

    <div class="help-card">
        <h2>Alert Content</h2>
        <p>GUIDELINE_DEVIATION alerts appear in ASP Alerts and include:</p>
        <ul>
            <li><strong>Bundle Info:</strong> Which guideline bundle triggered the alert</li>
            <li><strong>Element Details:</strong> Specific element that was not met</li>
            <li><strong>Time Window:</strong> Required completion timeframe and when it expired</li>
            <li><strong>Recommendation:</strong> Suggested action for ASP team</li>
            <li><strong>Overall Adherence:</strong> Current compliance percentage for this episode</li>
        </ul>
    </div>

    <div class="help-card">
        <h2>Dashboard Features</h2>
        <h3>Compliance Metrics</h3>
        <ul>
            <li>Overall compliance rate by bundle</li>
            <li>Element-level compliance breakdown</li>
            <li>Trend over time (7/30/90 days)</li>
            <li>Active episodes being monitored</li>
        </ul>

        <h3>Episode Detail View</h3>
        <ul>
            <li>Element timeline with status indicators</li>
            <li>Completion timestamps and values</li>
            <li>Deviation history and alerts</li>
            <li>Bundle reference information</li>
        </ul>
    </div>

    <div class="help-card">
        <h2>Joint Commission (JC) Compliance</h2>
        <p>This module supports MM.09.01.01 EP 18-19 compliance by:</p>
        <ul>
            <li>Implementing evidence-based guidelines for infectious disease treatment</li>
            <li>Real-time monitoring of antimicrobial stewardship protocols</li>
            <li>Generating aggregate compliance metrics for quality improvement</li>
            <li>Providing drill-down capability to individual episodes</li>
            <li>Documenting interventions through the alert resolution workflow</li>
        </ul>
    </div>

    <div class="help-card">
        <h2>References</h2>
        <ul>
            <li>Surviving Sepsis Campaign. International Guidelines for Management of Sepsis and Septic Shock. 2021.</li>
            <li>Bradley JS, et al. The Management of Community-Acquired Pneumonia in Infants and Children Older Than 3 Months of Age: PIDS and IDSA. Clin Infect Dis. 2011.</li>
            <li>The Joint Commission. MM.09.01.01 - Antimicrobial Stewardship Standard. Effective January 1, 2023.</li>
            <li>CMS Severe Sepsis and Septic Shock Early Management Bundle (SEP-1).</li>
        </ul>
    </div>
</div>

<style>
.help-card {
    background: var(--color-white);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    box-shadow: var(--shadow-md);
    margin-bottom: 1.5rem;
}

.help-card h2 {
    margin-top: 0;
    margin-bottom: 1rem;
    color: var(--color-gray-800);
    border-bottom: 2px solid var(--color-primary);
    padding-bottom: 0.5rem;
}

.help-card h3 {
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
    color: var(--color-gray-700);
}

.help-table {
    width: 100%;
    border-collapse: collapse;
    margin: 1rem 0;
}

.help-table th,
.help-table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid var(--color-gray-200);
}

.help-table th {
    background: var(--color-gray-50);
    font-weight: 600;
}

.workflow {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin: 1rem 0;
}

.workflow-step {
    display: flex;
    gap: 1rem;
    align-items: flex-start;
}

.step-number {
    flex-shrink: 0;
    width: 2rem;
    height: 2rem;
    background: var(--color-primary);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}

.step-content h4 {
    margin: 0;
}

.step-content p {
    margin: 0.25rem 0 0;
    color: var(--color-gray-600);
}

.code-block {
    background: var(--color-gray-800);
    color: var(--color-gray-100);
    padding: 1rem;
    border-radius: var(--radius-md);
    overflow-x: auto;
    font-size: 0.875rem;
    font-family: monospace;
    white-space: pre;
    margin: 0.5rem 0;
}
</style>
{% endblock %}
