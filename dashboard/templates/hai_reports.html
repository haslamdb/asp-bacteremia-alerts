{% extends "base.html" %}
{% from "macros/components.html" import stats_grid, quick_links, alert_box, empty_state, hai_type_badge, decision_badge, bar_chart, metric_row, filter_select %}

{% block title %}HAI Reports - {{ app_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>HAI Reports & Analytics</h1>
    <a href="{{ url_for('hai_detection.dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
</div>

{% if error %}
{{ alert_box("Unable to load some data.", "warning", error) }}
{% endif %}

<div class="filters">
    <form method="get" class="filter-form">
        {{ filter_select("type", hai_types, current_type, "HAI Type", true) }}
        {{ filter_select("days", [
            ("submission", "Since Last Submission" ~ (" (" ~ last_submission.period_end ~ ")" if last_submission else "")),
            ("7", "Last 7 days"),
            ("14", "Last 14 days"),
            ("30", "Last 30 days"),
            ("60", "Last 60 days"),
            ("90", "Last 90 days")
        ], current_days, "Time Period", true) }}
    </form>
</div>

<!-- Summary Stats -->
{{ stats_grid([
    {"value": report_data.total_confirmed, "label": "Confirmed HAI", "variant": "success"},
    {"value": report_data.total_rejected, "label": "Not HAI"},
    {"value": report_data.total_reviewed, "label": "Total Reviewed"},
    {"value": "%.1f"|format(report_data.confirmation_rate) ~ "%", "label": "HAI Rate", "variant": "info"}
]) }}

<div class="reports-layout">
    <!-- Left Column -->
    <div class="reports-main">
        <!-- HAI by Day Chart -->
        <div class="report-card">
            <h3>Confirmed HAI by Day</h3>
            {% if report_data.by_day %}
            {{ bar_chart(report_data.by_day, "bar-hai", true) }}
            {% else %}
            {{ empty_state("No confirmed HAI in this period.") }}
            {% endif %}
        </div>

        <!-- Confirmed HAI List -->
        <div class="report-card">
            <h3>Confirmed HAI Cases</h3>
            {% if confirmed_hais %}
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Patient</th>
                        <th>HAI Type</th>
                        <th>Organism</th>
                        <th>Device Days</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for hai in confirmed_hais %}
                    <tr>
                        <td>{{ hai.created_at.strftime('%Y-%m-%d') }}</td>
                        <td>
                            <strong>{{ hai.patient.name or 'Unknown' }}</strong>
                            <br><small class="text-muted">{{ hai.patient.mrn }}</small>
                        </td>
                        <td>{{ hai_type_badge(hai.hai_type.value) }}</td>
                        <td>{{ hai.culture.organism or 'Unknown' }}</td>
                        <td>{{ hai.device_days_at_culture if hai.device_days_at_culture is not none else '-' }}</td>
                        <td>
                            <a href="{{ url_for('hai_detection.candidate_detail', candidate_id=hai.id) }}" class="btn btn-small">View</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            {{ empty_state("No confirmed HAI cases in this period.") }}
            {% endif %}
        </div>
    </div>

    <!-- Right Column -->
    <div class="reports-sidebar">
        <!-- HAI by Type -->
        <div class="report-card">
            <h3>HAI by Type</h3>
            {% if report_data.by_type %}
            <div class="type-breakdown">
                {% set total_hai = report_data.total_confirmed or 1 %}
                {% for hai_type, count in report_data.by_type.items() %}
                <div class="type-item">
                    <div class="type-header">
                        <span class="badge badge-hai-{{ hai_type }}">{{ hai_type | upper }}</span>
                        <span class="type-count">{{ count }}</span>
                    </div>
                    <div class="type-bar-wrapper">
                        <div class="type-bar type-bar-{{ hai_type }}" style="width: {{ (count / total_hai * 100)|int }}%;"></div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="no-data">No HAI data available.</p>
            {% endif %}
        </div>

        <!-- LLM Quality Metrics -->
        <div class="report-card">
            <h3>LLM Classification Quality</h3>
            {% if override_stats and override_stats.completed_reviews > 0 %}
            <div class="quality-metrics">
                {{ metric_row("Completed Reviews", override_stats.completed_reviews) }}
                {{ metric_row("Acceptance Rate",
                    (override_stats.acceptance_rate_pct|string ~ "%") if override_stats.acceptance_rate_pct else "-",
                    "text-success" if override_stats.acceptance_rate_pct and override_stats.acceptance_rate_pct >= 80 else "text-warning" if override_stats.acceptance_rate_pct and override_stats.acceptance_rate_pct >= 60 else "text-danger") }}
                {{ metric_row("IP Overrides", override_stats.total_overrides) }}
                {{ metric_row("Override Rate",
                    (override_stats.override_rate_pct|string ~ "%") if override_stats.override_rate_pct else "-",
                    "text-success" if override_stats.override_rate_pct and override_stats.override_rate_pct <= 20 else "text-warning" if override_stats.override_rate_pct and override_stats.override_rate_pct <= 40 else "text-danger") }}
            </div>

            {% if override_stats.by_llm_decision %}
            <h4 class="subsection-title">Override Rate by LLM Decision</h4>
            <table class="breakdown-table">
                <thead>
                    <tr>
                        <th>LLM Said</th>
                        <th>Total</th>
                        <th>Overrides</th>
                        <th>Rate</th>
                    </tr>
                </thead>
                <tbody>
                    {% for decision, data in override_stats.by_llm_decision.items() %}
                    <tr>
                        <td>
                            {% if decision == 'hai_confirmed' %}
                                <span class="badge badge-success">HAI</span>
                            {% elif decision == 'not_hai' %}
                                <span class="badge badge-secondary">Not HAI</span>
                            {% elif decision == 'pending_review' %}
                                <span class="badge badge-warning">Uncertain</span>
                            {% else %}
                                <span class="badge">{{ decision }}</span>
                            {% endif %}
                        </td>
                        <td>{{ data.total }}</td>
                        <td>{{ data.overrides }}</td>
                        <td class="{% if data.override_rate_pct <= 20 %}text-success{% elif data.override_rate_pct <= 40 %}text-warning{% else %}text-danger{% endif %}">
                            {{ "%.1f"|format(data.override_rate_pct) }}%
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}
            {% else %}
            <p class="no-data">No reviewed cases yet.</p>
            {% endif %}
        </div>

        {% if recent_overrides and recent_overrides|length > 0 %}
        <!-- Recent Overrides -->
        <div class="report-card">
            <h3>Recent IP Overrides</h3>
            <div class="override-list">
                {% for override in recent_overrides[:5] %}
                <div class="override-item">
                    <div class="override-header">
                        <span class="patient-mrn">{{ override.patient_mrn }}</span>
                        <span class="override-date">{{ override.reviewed_at[:10] if override.reviewed_at else '' }}</span>
                    </div>
                    <div class="override-details">
                        <span class="organism">{{ override.organism or 'Unknown' }}</span>
                    </div>
                    <div class="override-decision">
                        <span class="llm-decision">
                            LLM:
                            {% if override.llm_decision == 'hai_confirmed' %}
                                <span class="badge badge-success badge-sm">HAI</span>
                            {% elif override.llm_decision == 'not_hai' %}
                                <span class="badge badge-secondary badge-sm">Not HAI</span>
                            {% else %}
                                <span class="badge badge-sm">{{ override.llm_decision }}</span>
                            {% endif %}
                        </span>
                        <span class="arrow">â†’</span>
                        <span class="ip-decision">
                            IP:
                            {% if override.reviewer_decision == 'confirmed' %}
                                <span class="badge badge-success badge-sm">Confirmed</span>
                            {% elif override.reviewer_decision == 'rejected' %}
                                <span class="badge badge-secondary badge-sm">Rejected</span>
                            {% else %}
                                <span class="badge badge-sm">{{ override.reviewer_decision }}</span>
                            {% endif %}
                        </span>
                    </div>
                    {% if override.reviewer_notes %}
                    <div class="override-notes">
                        <small>{{ override.reviewer_notes[:100] }}{% if override.reviewer_notes|length > 100 %}...{% endif %}</small>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Quick Links -->
        <div class="report-card">
            <h3>Quick Links</h3>
            {{ quick_links([
                {"url": url_for('hai_detection.dashboard'), "label": "Active Cases", "class": "btn-primary"},
                {"url": url_for('hai_detection.history'), "label": "Review History", "class": "btn-info"}
            ], vertical=true) }}
        </div>
    </div>
</div>
{% endblock %}
