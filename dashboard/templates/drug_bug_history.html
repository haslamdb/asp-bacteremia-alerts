{% extends "base.html" %}

{% block title %}Drug-Bug Mismatch History - {{ app_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Drug-Bug Mismatch History</h1>
    <div class="header-actions">
        <a href="{{ url_for('drug_bug.dashboard') }}" class="btn btn-secondary">Active Alerts</a>
        <a href="{{ url_for('drug_bug.help_page') }}" class="btn btn-secondary">Help</a>
    </div>
</div>

<!-- Filters -->
<div class="filter-bar">
    <form method="get" class="filter-form">
        <div class="filter-group">
            <label for="severity">Severity</label>
            <select name="severity" id="severity" onchange="this.form.submit()">
                <option value="">All</option>
                <option value="critical" {% if current_severity == 'critical' %}selected{% endif %}>Critical</option>
                <option value="warning" {% if current_severity == 'warning' %}selected{% endif %}>Warning</option>
                <option value="info" {% if current_severity == 'info' %}selected{% endif %}>Info</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="resolution">Resolution</label>
            <select name="resolution" id="resolution" onchange="this.form.submit()">
                <option value="">All</option>
                {% for value, display in resolution_reasons %}
                <option value="{{ value }}" {% if current_resolution == value %}selected{% endif %}>{{ display }}</option>
                {% endfor %}
            </select>
        </div>
        {% if current_severity or current_resolution %}
        <a href="{{ url_for('drug_bug.history') }}" class="btn btn-secondary btn-sm">Clear Filters</a>
        {% endif %}
    </form>
</div>

<!-- Resolved Alerts Table -->
{% if alerts %}
<div class="alerts-section">
    <h2>Resolved Mismatches ({{ alerts|length }})</h2>
    <table class="data-table alerts-table">
        <thead>
            <tr>
                <th>Severity</th>
                <th>Patient</th>
                <th>Organism</th>
                <th>Culture Source</th>
                <th>Antibiotic</th>
                <th>Resolution</th>
                <th>Resolved</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for alert in alerts %}
            <tr class="alert-row">
                <td>
                    <span class="badge badge-{{ alert.severity }}">{{ alert.severity|upper }}</span>
                </td>
                <td>
                    <div class="patient-info">
                        <strong>{{ alert.patient_name or 'Unknown' }}</strong>
                        <span class="mrn">{{ alert.patient_mrn or '' }}</span>
                    </div>
                </td>
                <td>
                    <strong>{{ alert.content.get('organism', 'Unknown') if alert.content else 'Unknown' }}</strong>
                </td>
                <td>
                    {{ alert.content.get('specimen_type', '-') if alert.content else '-' }}
                </td>
                <td>
                    {% if alert.content and alert.content.get('current_antibiotics') %}
                        {% for abx in alert.content.get('current_antibiotics', []) %}
                        <div class="abx-item">
                            {{ abx.get('name', 'Unknown') }}
                        </div>
                        {% endfor %}
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td>
                    {% if alert.resolution_reason %}
                    <span class="resolution-badge">{{ ResolutionReason.display_name(alert.resolution_reason) }}</span>
                    {% else %}
                    <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td>
                    <span class="time-relative" data-timestamp="{{ alert.resolved_at.isoformat() if alert.resolved_at else '' }}">
                        {{ alert.resolved_at.strftime('%m/%d %H:%M') if alert.resolved_at else '-' }}
                    </span>
                    {% if alert.resolved_by %}
                    <div class="resolved-by">by {{ alert.resolved_by }}</div>
                    {% endif %}
                </td>
                <td>
                    <a href="{{ url_for('asp_alerts.alert_detail', alert_id=alert.id) }}" class="btn btn-sm btn-secondary">View</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="empty-state">
    <div class="empty-state-icon">&#x1F4C2;</div>
    <h3>No Resolved Alerts</h3>
    <p>No drug-bug mismatch alerts have been resolved yet.</p>
</div>
{% endif %}

<style>
.header-actions {
    display: flex;
    gap: 0.5rem;
}

.filter-bar {
    background: var(--color-gray-50);
    padding: 1rem;
    border-radius: var(--radius-md);
    margin-bottom: 1.5rem;
}

.filter-form {
    display: flex;
    gap: 1rem;
    align-items: flex-end;
    flex-wrap: wrap;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.filter-group label {
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--color-gray-600);
}

.filter-group select {
    padding: 0.5rem;
    border: 1px solid var(--color-gray-300);
    border-radius: var(--radius-sm);
    min-width: 150px;
}

.alerts-section h2 {
    margin-bottom: 1rem;
    font-size: 1.25rem;
}

.patient-info {
    display: flex;
    flex-direction: column;
}

.patient-info .mrn {
    font-size: 0.75rem;
    color: var(--color-gray-500);
}

.abx-item {
    margin-bottom: 0.25rem;
}

.abx-item:last-child {
    margin-bottom: 0;
}

.resolution-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    background: var(--color-gray-100);
    border-radius: var(--radius-sm);
}

.resolved-by {
    font-size: 0.75rem;
    color: var(--color-gray-500);
}

.empty-state {
    text-align: center;
    padding: 3rem;
    background: var(--color-gray-50);
    border-radius: var(--radius-md);
    margin-top: 1rem;
}

.empty-state-icon {
    font-size: 3rem;
    color: var(--color-gray-400);
    margin-bottom: 1rem;
}

.empty-state h3 {
    margin: 0 0 0.5rem 0;
    color: var(--color-gray-700);
}

.empty-state p {
    margin: 0;
    color: var(--color-gray-500);
}
</style>
{% endblock %}
