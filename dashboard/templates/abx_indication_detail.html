{% extends "base.html" %}
{% from "macros/components.html" import reviewer_input, clinical_context_card %}

{% block title %}Indication Review - {{ candidate.medication.medication_name }} - {{ app_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Antibiotic Indication Review</h1>
    <a href="{{ url_for('abx_indications.dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
</div>

<div class="alert-detail-layout">
    <!-- Left Column: Candidate Information -->
    <div class="alert-detail-main">
        <!-- Clinical Context Card (MDR, Allergies, Renal) -->
        {% if clinical_context %}
        {{ clinical_context_card(clinical_context) }}
        {% endif %}

        <!-- Status Badge -->
        <div class="candidate-status-bar">
            <span class="badge badge-lg badge-classification-{{ candidate.final_classification }}">
                {{ {'A': 'Appropriate', 'S': 'Sometimes', 'N': 'Never Appropriate', 'P': 'Prophylaxis', 'FN': 'Febrile Neutropenia', 'U': 'Unknown'}.get(candidate.final_classification, 'Unknown') }}
            </span>
            <span class="status-source">via {{ candidate.classification_source }}</span>
        </div>

        <!-- Patient & Medication Info (info-grid pattern) -->
        <div class="alert-detail-card">
            <h3>Patient &amp; Order Information</h3>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">PATIENT MRN</span>
                    <span class="info-value patient-mrn">{{ candidate.patient.mrn or 'N/A' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">NAME</span>
                    <span class="info-value">{{ candidate.patient.name or 'N/A' }}</span>
                </div>
                {% if candidate.location %}
                <div class="info-item">
                    <span class="info-label">LOCATION</span>
                    <span class="info-value">{{ candidate.location }}</span>
                </div>
                {% endif %}
                {% if candidate.service %}
                <div class="info-item">
                    <span class="info-label">SERVICE</span>
                    <span class="info-value">{{ candidate.service }}</span>
                </div>
                {% endif %}
                <div class="info-item">
                    <span class="info-label">MEDICATION</span>
                    <span class="info-value medication-name">{{ candidate.medication.medication_name }}</span>
                </div>
                {% if candidate.medication.rxnorm_code %}
                <div class="info-item">
                    <span class="info-label">RXNORM</span>
                    <span class="info-value">{{ candidate.medication.rxnorm_code }}</span>
                </div>
                {% endif %}
                <div class="info-item">
                    <span class="info-label">ORDER DATE</span>
                    <span class="info-value">{{ candidate.medication.start_date.strftime('%Y-%m-%d %H:%M') if candidate.medication.start_date else 'Unknown' }}</span>
                </div>
                {% if candidate.medication.dose %}
                <div class="info-item">
                    <span class="info-label">DOSE</span>
                    <span class="info-value">{{ candidate.medication.dose }}</span>
                </div>
                {% endif %}
                {% if candidate.medication.route %}
                <div class="info-item">
                    <span class="info-label">ROUTE</span>
                    <span class="info-value">{{ candidate.medication.route }}</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- LLM Extraction (primary classification source) -->
        <div class="alert-detail-card">
            <div class="info-section">
                <h3>LLM Note Extraction</h3>

                {% if candidate.llm_classification %}
                <div class="classification-summary">
                    <span class="badge badge-classification-{{ candidate.llm_classification }}">
                        {{ candidate.llm_classification }}
                    </span>
                    {% if candidate.llm_extracted_indication %}
                    <span class="primary-indication">{{ candidate.llm_extracted_indication }}</span>
                    {% endif %}
                </div>
                {% endif %}

                {% if extraction %}
                <div class="extraction-details">
                    {% if extraction.indications %}
                    <div class="extraction-section">
                        <strong>Extracted Indications:</strong>
                        <ul>
                            {% for ind in extraction.indications %}
                            <li>{{ ind }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    {# New v2: Evidence sources with attribution #}
                    {% if extraction.evidence_sources %}
                    <div class="extraction-section evidence-sources">
                        <strong>Supporting Evidence with Sources:</strong>
                        {% for source in extraction.evidence_sources %}
                        <div class="evidence-item">
                            <div class="evidence-header">
                                <span class="badge badge-note-type">{{ source.note_type }}</span>
                                {% if source.note_date %}
                                <span class="evidence-date">{{ source.note_date }}</span>
                                {% endif %}
                                {% if source.author %}
                                <span class="evidence-author">by {{ source.author }}</span>
                                {% endif %}
                            </div>
                            {% if source.relevance %}
                            <div class="evidence-relevance">{{ source.relevance }}</div>
                            {% endif %}
                            {% if source.quotes %}
                            <ul class="evidence-quotes">
                                {% for quote in source.quotes %}
                                <li class="quote">"{{ quote }}"</li>
                                {% endfor %}
                            </ul>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {# Fallback to old format if no evidence_sources #}
                    {% elif extraction.supporting_quotes %}
                    <div class="extraction-section supporting-quotes">
                        <strong>Supporting Quotes from Notes:</strong>
                        <ul>
                            {% for quote in extraction.supporting_quotes %}
                            <li class="quote">"{{ quote }}"</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    <div class="extraction-meta">
                        <span class="confidence">Confidence: {{ "%.0f"|format((extraction.confidence or 0) * 100) }}%</span>
                        <span class="model">Model: {{ extraction.model_used }}</span>
                        {% if extraction.notes_filtered_count is not none and extraction.notes_total_count is not none %}
                        <span class="notes-count">Notes: {{ extraction.notes_filtered_count }}/{{ extraction.notes_total_count }}</span>
                        {% endif %}
                        {% if extraction.tokens_used %}
                        <span class="tokens">Tokens: {{ extraction.tokens_used }}</span>
                        {% endif %}
                    </div>
                </div>
                {% elif candidate.classification_source == 'icd10' %}
                <p class="text-muted">No LLM extraction performed. Classification based on ICD-10 codes only.</p>
                {% else %}
                <p class="text-muted">No extraction details available.</p>
                {% endif %}
            </div>
        </div>

        <!-- ICD-10 Classification -->
        <div class="alert-detail-card">
            <div class="info-section">
                <h3>ICD-10 Assessment</h3>
                <div class="classification-summary">
                    <span class="badge badge-classification-{{ candidate.icd10_classification }}">
                        {{ candidate.icd10_classification }}
                    </span>
                    {% if candidate.icd10_primary_indication %}
                    <span class="primary-indication">{{ candidate.icd10_primary_indication }}</span>
                    {% endif %}
                </div>

                {% if candidate.icd10_codes %}
                <div class="icd10-codes">
                    <strong>ICD-10 Codes:</strong>
                    <ul class="code-list">
                        {% for code in candidate.icd10_codes %}
                        <li><code>{{ code }}</code></li>
                        {% endfor %}
                    </ul>
                </div>
                {% else %}
                <p class="text-muted">No ICD-10 codes found for this encounter.</p>
                {% endif %}
            </div>
        </div>

        <!-- Classification Comparison -->
        <div class="alert-detail-card">
            <div class="info-section">
                <h3>Classification Comparison</h3>
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Source</th>
                            <th>Classification</th>
                            <th>Indication</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>ICD-10 (Chua)</td>
                            <td><span class="badge badge-classification-{{ candidate.icd10_classification }}">{{ candidate.icd10_classification }}</span></td>
                            <td>{{ candidate.icd10_primary_indication or '-' }}</td>
                        </tr>
                        {% if candidate.llm_classification %}
                        <tr>
                            <td>LLM (Notes)</td>
                            <td><span class="badge badge-classification-{{ candidate.llm_classification }}">{{ candidate.llm_classification }}</span></td>
                            <td>{{ candidate.llm_extracted_indication or '-' }}</td>
                        </tr>
                        {% endif %}
                        <tr class="final-row">
                            <td><strong>Final</strong></td>
                            <td><span class="badge badge-lg badge-classification-{{ candidate.final_classification }}">{{ candidate.final_classification }}</span></td>
                            <td><em>{{ candidate.classification_source }} classification used</em></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Review History -->
        {% if reviews %}
        <div class="alert-detail-card">
            <div class="info-section">
                <h3>Review History</h3>
                {% for review in reviews %}
                <div class="review-item {% if review.is_override %}review-override{% endif %}">
                    <div class="review-header">
                        <span class="reviewer">{{ review.reviewer }}</span>
                        <span class="review-date">{{ review.reviewed_at }}</span>
                        {% if review.is_override %}
                        <span class="badge badge-warning">Override</span>
                        {% endif %}
                    </div>
                    <div class="review-decision">
                        Decision: <strong>{{ review.decision | replace('_', ' ') | title }}</strong>
                    </div>
                    {% if review.override_reason %}
                    <div class="override-reason">
                        <strong>Override Reason:</strong> {{ review.override_reason }}
                    </div>
                    {% endif %}
                    {% if review.notes %}
                    <div class="review-notes">
                        <strong>Notes:</strong> {{ review.notes }}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Right Column: Review Actions -->
    <div class="alert-detail-sidebar">
        {% if candidate.status != 'reviewed' %}
        <div class="action-card">
            <h3>Review Indication</h3>

            {{ reviewer_input() }}

            <!-- Step 1: Syndrome Review -->
            <div class="review-step">
                <div class="step-header">
                    <span class="step-number">1</span>
                    <span class="step-title">Is the extracted indication correct?</span>
                </div>

                {% if extraction and extraction.indications %}
                <div class="extracted-indication-box">
                    <strong>LLM Extracted:</strong> {{ extraction.indications[0] if extraction.indications else 'None' }}
                </div>
                {% endif %}

                <div class="syndrome-buttons">
                    <button type="button" class="btn btn-syndrome-confirm btn-block" data-syndrome-decision="confirm_syndrome">
                        Yes, Indication is Correct
                    </button>
                    <button type="button" class="btn btn-syndrome-correct btn-block" data-syndrome-decision="correct_syndrome">
                        No, Change Indication
                    </button>
                </div>

                <!-- Correction dropdown (shown when "correct_syndrome" selected) -->
                <div id="syndrome-correction-section" class="hidden">
                    <div class="form-group">
                        <label for="corrected_syndrome">Select correct indication:</label>
                        <select id="corrected_syndrome" class="form-control">
                            <option value="">-- Select indication --</option>
                            <optgroup label="Respiratory">
                                <option value="cap">Community-Acquired Pneumonia</option>
                                <option value="hap">Hospital-Acquired Pneumonia</option>
                                <option value="vap">Ventilator-Associated Pneumonia</option>
                                <option value="aspiration_pneumonia">Aspiration Pneumonia</option>
                                <option value="empyema">Empyema / Parapneumonic Effusion</option>
                            </optgroup>
                            <optgroup label="Bloodstream">
                                <option value="bacteremia_gpc">Gram-Positive Bacteremia</option>
                                <option value="bacteremia_gnr">Gram-Negative Bacteremia</option>
                                <option value="sepsis">Sepsis</option>
                                <option value="line_infection">Central Line Infection / CLABSI</option>
                                <option value="endocarditis">Endocarditis</option>
                            </optgroup>
                            <optgroup label="Urinary">
                                <option value="uti_simple">Uncomplicated UTI / Cystitis</option>
                                <option value="uti_complicated">Complicated UTI / Pyelonephritis</option>
                                <option value="cauti">Catheter-Associated UTI</option>
                            </optgroup>
                            <optgroup label="Intra-abdominal">
                                <option value="appendicitis">Appendicitis</option>
                                <option value="intraabdominal_infection">Intra-abdominal Infection</option>
                                <option value="cdiff">C. difficile Infection</option>
                            </optgroup>
                            <optgroup label="Skin/Soft Tissue">
                                <option value="cellulitis">Cellulitis</option>
                                <option value="abscess">Skin Abscess</option>
                                <option value="wound_infection">Wound Infection / SSI</option>
                                <option value="necrotizing_fasciitis">Necrotizing Fasciitis</option>
                            </optgroup>
                            <optgroup label="CNS">
                                <option value="meningitis">Bacterial Meningitis</option>
                                <option value="shunt_infection">VP Shunt Infection</option>
                                <option value="brain_abscess">Brain Abscess</option>
                            </optgroup>
                            <optgroup label="Bone/Joint">
                                <option value="osteomyelitis">Osteomyelitis</option>
                                <option value="septic_arthritis">Septic Arthritis</option>
                            </optgroup>
                            <optgroup label="ENT">
                                <option value="acute_otitis_media">Acute Otitis Media</option>
                                <option value="sinusitis">Acute Bacterial Sinusitis</option>
                                <option value="peritonsillar_abscess">Peritonsillar Abscess</option>
                                <option value="strep_pharyngitis">Strep Pharyngitis</option>
                                <option value="mastoiditis">Acute Mastoiditis</option>
                            </optgroup>
                            <optgroup label="Eye">
                                <option value="orbital_cellulitis">Orbital Cellulitis</option>
                                <option value="periorbital_cellulitis">Periorbital / Preseptal Cellulitis</option>
                            </optgroup>
                            <optgroup label="Other">
                                <option value="febrile_neutropenia">Febrile Neutropenia</option>
                                <option value="surgical_prophylaxis">Surgical Prophylaxis</option>
                                <option value="pcp_prophylaxis">PCP Prophylaxis</option>
                                <option value="empiric_unknown">Empiric - Source Unknown</option>
                                <option value="culture_directed">Culture-Directed Therapy</option>
                            </optgroup>
                        </select>
                    </div>
                </div>

                <div class="classification-divider">
                    <span>Or flag as:</span>
                </div>

                <div class="flag-buttons">
                    <button type="button" class="btn btn-flag-viral" data-syndrome-decision="viral_illness">
                        Viral Illness
                    </button>
                    <button type="button" class="btn btn-flag-asb" data-syndrome-decision="asymptomatic_bacteriuria">
                        Asymptomatic Bacteriuria
                    </button>
                    <button type="button" class="btn btn-flag-none" data-syndrome-decision="no_indication">
                        No Indication Documented
                    </button>
                </div>
            </div>

            <!-- Step 2: Agent Appropriateness (Optional) -->
            <div class="review-step" id="agent-review-step">
                <div class="step-header">
                    <span class="step-number">2</span>
                    <span class="step-title">Is {{ candidate.medication.medication_name }} appropriate? <span class="optional-tag">(optional)</span></span>
                </div>

                <div class="agent-buttons">
                    <button type="button" class="btn btn-agent-appropriate" data-agent-decision="agent_appropriate">
                        Appropriate
                    </button>
                    <button type="button" class="btn btn-agent-acceptable" data-agent-decision="agent_acceptable">
                        Acceptable
                    </button>
                    <button type="button" class="btn btn-agent-inappropriate" data-agent-decision="agent_inappropriate">
                        Inappropriate
                    </button>
                    <button type="button" class="btn btn-agent-skip" data-agent-decision="agent_skip">
                        Skip
                    </button>
                </div>
            </div>

            <!-- Notes -->
            <div class="form-group" style="margin-top: 1rem;">
                <label for="notes">Notes (optional)</label>
                <textarea name="notes" id="notes" rows="2" class="form-textarea" placeholder="Additional context..."></textarea>
            </div>

            <button type="button" id="submit-review-btn" class="btn btn-primary btn-block" style="margin-top: 1rem; padding: 1rem; font-size: 1rem;">
                Submit Review
            </button>
        </div>

        <div id="review-result" class="hidden"></div>

        {% else %}
        <div class="action-card resolved-card">
            <h3>Review Complete</h3>
            <div class="review-complete">
                <span class="status-icon">&#x2713;</span>
                <strong>This order has been reviewed</strong>
                <p>Classification: {{ candidate.final_classification }}</p>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
let selectedSyndromeDecision = null;
let selectedAgentDecision = null;

// Syndrome decision buttons
document.querySelectorAll('[data-syndrome-decision]').forEach(btn => {
    btn.addEventListener('click', function() {
        const decision = this.getAttribute('data-syndrome-decision');
        selectedSyndromeDecision = decision;

        // Highlight selected button
        document.querySelectorAll('[data-syndrome-decision]').forEach(b => {
            b.classList.remove('selected');
        });
        this.classList.add('selected');

        // Show/hide correction dropdown
        const correctionSection = document.getElementById('syndrome-correction-section');
        if (decision === 'correct_syndrome') {
            correctionSection.classList.remove('hidden');
        } else {
            correctionSection.classList.add('hidden');
        }
    });
});

// Agent decision buttons
document.querySelectorAll('[data-agent-decision]').forEach(btn => {
    btn.addEventListener('click', function() {
        const decision = this.getAttribute('data-agent-decision');
        selectedAgentDecision = decision;

        // Highlight selected button
        document.querySelectorAll('[data-agent-decision]').forEach(b => {
            b.classList.remove('selected');
        });
        this.classList.add('selected');
    });
});

// Submit button click handler
document.getElementById('submit-review-btn').addEventListener('click', submitReview);

async function submitReview() {
    const reviewer = document.getElementById('reviewer').value.trim();
    const notes = document.getElementById('notes').value.trim();
    const correctedSyndrome = document.getElementById('corrected_syndrome')?.value || '';
    const resultDiv = document.getElementById('review-result');

    if (!reviewer) {
        resultDiv.innerHTML = '<div class="alert alert-danger">Please enter your name</div>';
        resultDiv.classList.remove('hidden');
        document.getElementById('reviewer').focus();
        return;
    }

    if (!selectedSyndromeDecision) {
        resultDiv.innerHTML = '<div class="alert alert-danger">Please select whether the indication is correct (Step 1)</div>';
        resultDiv.classList.remove('hidden');
        return;
    }

    if (selectedSyndromeDecision === 'correct_syndrome' && !correctedSyndrome) {
        resultDiv.innerHTML = '<div class="alert alert-danger">Please select the correct indication</div>';
        resultDiv.classList.remove('hidden');
        document.getElementById('corrected_syndrome').focus();
        return;
    }

    const data = {
        reviewer: reviewer,
        syndrome_decision: selectedSyndromeDecision,
        confirmed_syndrome: correctedSyndrome || null,
        agent_decision: selectedAgentDecision || 'agent_skip',
        notes: notes
    };

    try {
        const response = await fetch('{{ url_for("abx_indications.submit_review", candidate_id=candidate.id) }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
            resultDiv.innerHTML = '<div class="alert alert-success">Review submitted! Refreshing...</div>';
            resultDiv.classList.remove('hidden');
            setTimeout(() => window.location.reload(), 1500);
        } else {
            resultDiv.innerHTML = '<div class="alert alert-danger">Error: ' + result.error + '</div>';
            resultDiv.classList.remove('hidden');
        }
    } catch (err) {
        resultDiv.innerHTML = '<div class="alert alert-danger">Failed to submit: ' + err.message + '</div>';
        resultDiv.classList.remove('hidden');
    }
}
</script>

<style>
.candidate-status-bar {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.status-source {
    color: var(--color-gray-500);
    font-size: 0.875rem;
}

.badge-lg {
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
}

/* Info grid pattern (like surgical prophylaxis) */
.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}

.info-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.info-label {
    font-size: 0.7rem;
    font-weight: 600;
    color: var(--color-gray-500);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.info-value {
    font-size: 0.875rem;
    color: var(--color-gray-800);
}

.patient-mrn {
    font-family: monospace;
    font-weight: 600;
}

.medication-name {
    font-weight: 600;
    color: var(--color-primary);
}

/* Classification badges */
.badge-classification-A { background: var(--color-success); color: white; }
.badge-classification-FN { background: var(--color-success); color: white; }
.badge-classification-S { background: var(--color-warning); color: var(--color-gray-900); }
.badge-classification-N { background: var(--color-danger); color: white; }
.badge-classification-P { background: var(--color-primary); color: white; }
.badge-classification-U { background: var(--color-gray-400); color: white; }

.classification-summary {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.primary-indication {
    font-weight: 500;
    color: var(--color-gray-700);
}

.icd10-codes {
    margin-top: 1rem;
}

.code-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    list-style: none;
    padding: 0;
    margin: 0.5rem 0 0 0;
}

.code-list li code {
    background: var(--color-gray-100);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.875rem;
}

/* Extraction details */
.extraction-details {
    margin-top: 1rem;
}

.extraction-section {
    margin-bottom: 1rem;
    padding: 1rem;
    background: var(--color-gray-50);
    border-radius: 8px;
}

.extraction-section ul {
    margin: 0.5rem 0 0 1.5rem;
    padding: 0;
}

.supporting-quotes {
    border-left: 3px solid var(--color-primary);
}

.supporting-quotes .quote {
    font-style: italic;
    color: var(--color-gray-600);
    margin-bottom: 0.5rem;
}

/* Evidence sources with attribution */
.evidence-sources {
    border-left: 3px solid var(--color-success);
}

.evidence-item {
    background: var(--color-white);
    border: 1px solid var(--color-gray-200);
    border-radius: 6px;
    padding: 0.75rem;
    margin-bottom: 0.75rem;
}

.evidence-item:last-child {
    margin-bottom: 0;
}

.evidence-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.5rem;
    flex-wrap: wrap;
}

.badge-note-type {
    background: var(--color-primary);
    color: white;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
}

.evidence-date {
    font-size: 0.8rem;
    color: var(--color-gray-600);
}

.evidence-author {
    font-size: 0.8rem;
    color: var(--color-gray-600);
    font-style: italic;
}

.evidence-relevance {
    font-size: 0.85rem;
    color: var(--color-gray-700);
    margin-bottom: 0.5rem;
    padding-left: 0.5rem;
    border-left: 2px solid var(--color-gray-300);
}

.evidence-quotes {
    margin: 0;
    padding-left: 1.5rem;
}

.evidence-quotes .quote {
    font-style: italic;
    color: var(--color-gray-600);
    font-size: 0.85rem;
    margin-bottom: 0.25rem;
}

.notes-count {
    background: var(--color-gray-100);
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
}

.extraction-meta {
    display: flex;
    gap: 1.5rem;
    font-size: 0.8rem;
    color: var(--color-gray-500);
    margin-top: 1rem;
    padding-top: 0.5rem;
    border-top: 1px solid var(--color-gray-200);
    flex-wrap: wrap;
}

/* Comparison table */
.comparison-table {
    width: 100%;
    border-collapse: collapse;
}

.comparison-table th,
.comparison-table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid var(--color-gray-200);
}

.comparison-table th {
    background: var(--color-gray-50);
    font-weight: 600;
}

.comparison-table .final-row {
    background: var(--color-gray-50);
}

/* Review history */
.review-item {
    padding: 1rem;
    background: var(--color-gray-50);
    border-radius: 8px;
    margin-bottom: 0.75rem;
}

.review-item.review-override {
    border-left: 4px solid var(--color-warning);
}

.review-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.5rem;
}

.reviewer {
    font-weight: 600;
}

.review-date {
    color: var(--color-gray-500);
    font-size: 0.8rem;
}

.review-decision,
.override-reason,
.review-notes {
    margin-top: 0.5rem;
    font-size: 0.875rem;
}

/* Review Steps */
.review-step {
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--color-gray-200);
}

.step-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
}

.step-number {
    width: 1.5rem;
    height: 1.5rem;
    background: var(--color-primary);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: 600;
}

.step-title {
    font-weight: 600;
    font-size: 0.9rem;
}

.optional-tag {
    font-weight: 400;
    color: var(--color-gray-500);
    font-size: 0.8rem;
}

.extracted-indication-box {
    background: var(--color-gray-100);
    padding: 0.75rem;
    border-radius: 6px;
    margin-bottom: 0.75rem;
    font-size: 0.9rem;
}

/* Syndrome buttons */
.syndrome-buttons {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
}

.btn-syndrome-confirm {
    background: var(--color-success);
    color: white;
    border: 2px solid var(--color-success);
    padding: 0.75rem;
    font-weight: 600;
}

.btn-syndrome-confirm:hover { background: #15803d; }

.btn-syndrome-correct {
    background: white;
    color: var(--color-primary);
    border: 2px solid var(--color-primary);
    padding: 0.75rem;
    font-weight: 500;
}

.btn-syndrome-correct:hover { background: var(--color-primary); color: white; }

/* Flag buttons */
.flag-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem;
}

.flag-buttons button {
    padding: 0.5rem;
    font-size: 0.8rem;
    border-radius: 6px;
}

.btn-flag-viral {
    background: white;
    color: var(--color-warning);
    border: 1px solid var(--color-warning);
}

.btn-flag-viral:hover { background: var(--color-warning); color: white; }

.btn-flag-asb {
    background: white;
    color: var(--color-warning);
    border: 1px solid var(--color-warning);
}

.btn-flag-asb:hover { background: var(--color-warning); color: white; }

.btn-flag-none {
    background: white;
    color: var(--color-danger);
    border: 1px solid var(--color-danger);
    grid-column: span 2;
}

.btn-flag-none:hover { background: var(--color-danger); color: white; }

/* Agent buttons */
.agent-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem;
}

.agent-buttons button {
    padding: 0.6rem;
    font-size: 0.85rem;
    border-radius: 6px;
}

.btn-agent-appropriate {
    background: white;
    color: var(--color-success);
    border: 2px solid var(--color-success);
}

.btn-agent-appropriate:hover { background: var(--color-success); color: white; }

.btn-agent-acceptable {
    background: white;
    color: var(--color-primary);
    border: 2px solid var(--color-primary);
}

.btn-agent-acceptable:hover { background: var(--color-primary); color: white; }

.btn-agent-inappropriate {
    background: white;
    color: var(--color-danger);
    border: 2px solid var(--color-danger);
}

.btn-agent-inappropriate:hover { background: var(--color-danger); color: white; }

.btn-agent-skip {
    background: white;
    color: var(--color-gray-500);
    border: 2px solid var(--color-gray-300);
}

.btn-agent-skip:hover { background: var(--color-gray-100); }

/* Selected state for all buttons */
[data-syndrome-decision].selected,
[data-agent-decision].selected {
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
}

.classification-divider {
    margin: 1.25rem 0;
    text-align: center;
    color: var(--color-gray-500);
    font-size: 0.8rem;
    position: relative;
}

.classification-divider::before,
.classification-divider::after {
    content: '';
    position: absolute;
    top: 50%;
    width: 20%;
    height: 1px;
    background: var(--color-gray-300);
}

.classification-divider::before { left: 0; }
.classification-divider::after { right: 0; }

.form-help {
    font-size: 0.75rem;
    color: var(--color-gray-500);
    margin-top: 0.5rem;
}

/* Form controls */
.form-control {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--color-gray-300);
    border-radius: 6px;
    font-size: 1rem;
}

.form-control:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-textarea {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--color-gray-300);
    border-radius: 6px;
    font-size: 0.875rem;
    resize: vertical;
    font-family: inherit;
}

.form-textarea:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

/* Alerts */
.alert {
    padding: 1rem;
    border-radius: 8px;
    margin-top: 1rem;
}

.alert-danger {
    background: #fef2f2;
    border: 1px solid #ef4444;
    color: #991b1b;
}

.alert-success {
    background: #f0fdf4;
    border: 1px solid #10b981;
    color: #065f46;
}

.hidden {
    display: none !important;
}

/* Review complete state */
.review-complete {
    text-align: center;
    padding: 1.5rem;
}

.review-complete .status-icon {
    font-size: 2rem;
    color: var(--color-success);
    display: block;
    margin-bottom: 0.5rem;
}

.resolved-card {
    background: var(--color-gray-50);
}
</style>

{% endblock %}
