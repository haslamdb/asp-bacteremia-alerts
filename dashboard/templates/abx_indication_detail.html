{% extends "base.html" %}

{% block title %}Indication Review - {{ candidate.medication.medication_name }} - {{ app_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Antibiotic Indication Review</h1>
    <a href="{{ url_for('abx_indications.dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
</div>

<div class="alert-detail-layout">
    <!-- Left Column: Candidate Information -->
    <div class="alert-detail-main">
        <!-- Status Badge -->
        <div class="candidate-status-bar">
            <span class="badge badge-lg badge-classification-{{ candidate.final_classification }}">
                {{ {'A': 'Appropriate', 'S': 'Sometimes', 'N': 'Never Appropriate', 'P': 'Prophylaxis', 'FN': 'Febrile Neutropenia', 'U': 'Unknown'}.get(candidate.final_classification, 'Unknown') }}
            </span>
            <span class="status-source">via {{ candidate.classification_source }}</span>
        </div>

        <!-- Patient & Medication Info -->
        <div class="alert-detail-card">
            <div class="info-row-compact">
                <div class="info-section">
                    <h3>Patient</h3>
                    <dl>
                        <dt>MRN</dt>
                        <dd><strong>{{ candidate.patient.mrn or 'N/A' }}</strong></dd>
                        <dt>Name</dt>
                        <dd>{{ candidate.patient.name or 'N/A' }}</dd>
                        {% if candidate.location %}
                        <dt>Location</dt>
                        <dd>{{ candidate.location }}</dd>
                        {% endif %}
                        {% if candidate.service %}
                        <dt>Service</dt>
                        <dd>{{ candidate.service }}</dd>
                        {% endif %}
                    </dl>
                </div>

                <div class="info-section">
                    <h3>Antibiotic Order</h3>
                    <dl>
                        <dt>Medication</dt>
                        <dd><strong>{{ candidate.medication.medication_name }}</strong></dd>
                        {% if candidate.medication.rxnorm_code %}
                        <dt>RxNorm</dt>
                        <dd>{{ candidate.medication.rxnorm_code }}</dd>
                        {% endif %}
                        <dt>Order Date</dt>
                        <dd>{{ candidate.medication.start_date.strftime('%Y-%m-%d %H:%M') if candidate.medication.start_date else 'Unknown' }}</dd>
                        {% if candidate.medication.dose %}
                        <dt>Dose</dt>
                        <dd>{{ candidate.medication.dose }}</dd>
                        {% endif %}
                        {% if candidate.medication.route %}
                        <dt>Route</dt>
                        <dd>{{ candidate.medication.route }}</dd>
                        {% endif %}
                    </dl>
                </div>
            </div>
        </div>

        <!-- ICD-10 Classification -->
        <div class="alert-detail-card">
            <div class="info-section">
                <h3>ICD-10 Assessment</h3>
                <div class="classification-summary">
                    <span class="badge badge-classification-{{ candidate.icd10_classification }}">
                        {{ candidate.icd10_classification }}
                    </span>
                    {% if candidate.icd10_primary_indication %}
                    <span class="primary-indication">{{ candidate.icd10_primary_indication }}</span>
                    {% endif %}
                </div>

                {% if candidate.icd10_codes %}
                <div class="icd10-codes">
                    <strong>ICD-10 Codes:</strong>
                    <ul class="code-list">
                        {% for code in candidate.icd10_codes %}
                        <li><code>{{ code }}</code></li>
                        {% endfor %}
                    </ul>
                </div>
                {% else %}
                <p class="text-muted">No ICD-10 codes found for this encounter.</p>
                {% endif %}
            </div>
        </div>

        <!-- LLM Extraction -->
        <div class="alert-detail-card">
            <div class="info-section">
                <h3>LLM Note Extraction</h3>

                {% if candidate.llm_classification %}
                <div class="classification-summary">
                    <span class="badge badge-classification-{{ candidate.llm_classification }}">
                        {{ candidate.llm_classification }}
                    </span>
                    {% if candidate.llm_extracted_indication %}
                    <span class="primary-indication">{{ candidate.llm_extracted_indication }}</span>
                    {% endif %}
                </div>
                {% endif %}

                {% if extraction %}
                <div class="extraction-details">
                    {% if extraction.indications %}
                    <div class="extraction-section">
                        <strong>Extracted Indications:</strong>
                        <ul>
                            {% for ind in extraction.indications %}
                            <li>{{ ind }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    {% if extraction.supporting_quotes %}
                    <div class="extraction-section supporting-quotes">
                        <strong>Supporting Quotes from Notes:</strong>
                        <ul>
                            {% for quote in extraction.supporting_quotes %}
                            <li class="quote">"{{ quote }}"</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    <div class="extraction-meta">
                        <span class="confidence">Confidence: {{ "%.0f"|format((extraction.confidence or 0) * 100) }}%</span>
                        <span class="model">Model: {{ extraction.model_used }}</span>
                        {% if extraction.tokens_used %}
                        <span class="tokens">Tokens: {{ extraction.tokens_used }}</span>
                        {% endif %}
                    </div>
                </div>
                {% elif candidate.classification_source == 'icd10' %}
                <p class="text-muted">No LLM extraction performed. Classification based on ICD-10 codes only.</p>
                {% else %}
                <p class="text-muted">No extraction details available.</p>
                {% endif %}
            </div>
        </div>

        <!-- Classification Comparison -->
        <div class="alert-detail-card">
            <div class="info-section">
                <h3>Classification Comparison</h3>
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Source</th>
                            <th>Classification</th>
                            <th>Indication</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>ICD-10 (Chua)</td>
                            <td><span class="badge badge-classification-{{ candidate.icd10_classification }}">{{ candidate.icd10_classification }}</span></td>
                            <td>{{ candidate.icd10_primary_indication or '-' }}</td>
                        </tr>
                        {% if candidate.llm_classification %}
                        <tr>
                            <td>LLM (Notes)</td>
                            <td><span class="badge badge-classification-{{ candidate.llm_classification }}">{{ candidate.llm_classification }}</span></td>
                            <td>{{ candidate.llm_extracted_indication or '-' }}</td>
                        </tr>
                        {% endif %}
                        <tr class="final-row">
                            <td><strong>Final</strong></td>
                            <td><span class="badge badge-lg badge-classification-{{ candidate.final_classification }}">{{ candidate.final_classification }}</span></td>
                            <td><em>{{ candidate.classification_source }} classification used</em></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Review History -->
        {% if reviews %}
        <div class="alert-detail-card">
            <div class="info-section">
                <h3>Review History</h3>
                {% for review in reviews %}
                <div class="review-item {% if review.is_override %}review-override{% endif %}">
                    <div class="review-header">
                        <span class="reviewer">{{ review.reviewer }}</span>
                        <span class="review-date">{{ review.reviewed_at }}</span>
                        {% if review.is_override %}
                        <span class="badge badge-warning">Override</span>
                        {% endif %}
                    </div>
                    <div class="review-decision">
                        Decision: <strong>{{ review.decision | replace('_', ' ') | title }}</strong>
                    </div>
                    {% if review.override_reason %}
                    <div class="override-reason">
                        <strong>Override Reason:</strong> {{ review.override_reason }}
                    </div>
                    {% endif %}
                    {% if review.notes %}
                    <div class="review-notes">
                        <strong>Notes:</strong> {{ review.notes }}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Right Column: Review Actions -->
    <div class="alert-detail-sidebar">
        {% if candidate.status != 'reviewed' %}
        <div class="action-card">
            <h3>Submit Review</h3>

            <div class="form-group">
                <label for="reviewer">Reviewer Name</label>
                <input type="text" name="reviewer" id="reviewer" required placeholder="Enter your name" class="form-control">
            </div>

            <div class="classification-divider">
                <span>Confirm Classification:</span>
            </div>

            <div class="confirm-buttons">
                {% if candidate.final_classification == 'A' %}
                <button type="button" class="btn btn-appropriate btn-block" data-decision="confirm_appropriate">
                    Confirm Appropriate (A)
                </button>
                {% elif candidate.final_classification == 'S' %}
                <button type="button" class="btn btn-sometimes btn-block" data-decision="confirm_sometimes">
                    Confirm Sometimes (S)
                </button>
                {% elif candidate.final_classification == 'N' %}
                <button type="button" class="btn btn-inappropriate btn-block" data-decision="confirm_inappropriate">
                    Confirm Not Appropriate (N)
                </button>
                {% else %}
                <button type="button" class="btn btn-secondary btn-block" data-decision="confirm_appropriate">
                    Confirm as Classified
                </button>
                {% endif %}
            </div>

            <div class="classification-divider">
                <span>Or Override To:</span>
            </div>

            <div class="override-buttons">
                {% if candidate.final_classification != 'A' %}
                <button type="button" class="btn btn-override-appropriate" data-decision="override_to_appropriate">
                    Appropriate (A)
                </button>
                {% endif %}
                {% if candidate.final_classification != 'S' %}
                <button type="button" class="btn btn-override-sometimes" data-decision="override_to_sometimes">
                    Sometimes (S)
                </button>
                {% endif %}
                {% if candidate.final_classification != 'N' %}
                <button type="button" class="btn btn-override-inappropriate" data-decision="override_to_inappropriate">
                    Never (N)
                </button>
                {% endif %}
                {% if candidate.final_classification != 'P' %}
                <button type="button" class="btn btn-override-prophylaxis" data-decision="override_to_prophylaxis">
                    Prophylaxis (P)
                </button>
                {% endif %}
            </div>

            <div id="override-reason-section" class="hidden">
                <div class="form-group">
                    <label for="override_reason">Override Reason (required)</label>
                    <input type="text" name="override_reason" id="override_reason" placeholder="Why are you overriding?" class="form-control">
                </div>
            </div>

            <div class="form-group" style="margin-top: 1rem;">
                <label for="notes">Notes (optional)</label>
                <textarea name="notes" id="notes" rows="3" class="form-textarea" placeholder="Add details about your review decision..."></textarea>
                <p class="form-help">Your notes help improve future AI classifications.</p>
            </div>

            <button type="button" id="submit-review-btn" class="btn btn-primary btn-block" style="margin-top: 1rem; padding: 1rem; font-size: 1rem;">
                Submit Review
            </button>

            <div class="classification-divider" style="margin-top: 1.5rem;">
                <span>Or Quick Actions:</span>
            </div>

            <button type="button" id="acknowledge-btn" class="btn btn-secondary btn-block" style="margin-top: 0.5rem;">
                Acknowledge &amp; Clear
            </button>
            <p class="form-help" style="margin-top: 0.25rem; font-size: 0.75rem;">
                Mark as reviewed without changing classification
            </p>
        </div>

        <div id="review-result" class="hidden"></div>

        {% else %}
        <div class="action-card resolved-card">
            <h3>Review Complete</h3>
            <div class="review-complete">
                <span class="status-icon">&#x2713;</span>
                <strong>This order has been reviewed</strong>
                <p>Classification: {{ candidate.final_classification }}</p>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
let selectedDecision = null;

document.querySelectorAll('.confirm-buttons button, .override-buttons button').forEach(btn => {
    btn.addEventListener('click', function() {
        const decision = this.getAttribute('data-decision');
        selectedDecision = decision;

        // Highlight selected button
        document.querySelectorAll('.confirm-buttons button, .override-buttons button').forEach(b => {
            b.classList.remove('selected');
        });
        this.classList.add('selected');

        // Show override reason if needed
        const overrideSection = document.getElementById('override-reason-section');
        if (decision.startsWith('override_')) {
            overrideSection.classList.remove('hidden');
        } else {
            overrideSection.classList.add('hidden');
        }
    });
});

// Submit button click handler
document.getElementById('submit-review-btn').addEventListener('click', submitReview);

// Acknowledge button click handler
document.getElementById('acknowledge-btn')?.addEventListener('click', acknowledgeCandidate);

async function submitReview() {
    if (!selectedDecision) {
        alert('Please select a decision first (click one of the buttons above)');
        return;
    }

    const reviewer = document.getElementById('reviewer').value.trim();
    const notes = document.getElementById('notes').value.trim();
    const overrideReason = document.getElementById('override_reason')?.value?.trim() || '';
    const resultDiv = document.getElementById('review-result');

    if (!reviewer) {
        resultDiv.innerHTML = '<div class="alert alert-danger">Please enter your name</div>';
        resultDiv.classList.remove('hidden');
        document.getElementById('reviewer').focus();
        return;
    }

    if (selectedDecision.startsWith('override_') && !overrideReason) {
        resultDiv.innerHTML = '<div class="alert alert-danger">Please provide an override reason</div>';
        resultDiv.classList.remove('hidden');
        document.getElementById('override_reason').focus();
        return;
    }

    const data = {
        reviewer: reviewer,
        decision: selectedDecision,
        notes: notes,
        override_reason: overrideReason
    };

    try {
        const response = await fetch('{{ url_for("abx_indications.submit_review", candidate_id=candidate.id) }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
            resultDiv.innerHTML = '<div class="alert alert-success">Review submitted! Refreshing...</div>';
            resultDiv.classList.remove('hidden');
            setTimeout(() => window.location.reload(), 1500);
        } else {
            resultDiv.innerHTML = '<div class="alert alert-danger">Error: ' + result.error + '</div>';
            resultDiv.classList.remove('hidden');
        }
    } catch (err) {
        resultDiv.innerHTML = '<div class="alert alert-danger">Failed to submit: ' + err.message + '</div>';
        resultDiv.classList.remove('hidden');
    }
}

async function acknowledgeCandidate() {
    const reviewer = document.getElementById('reviewer').value.trim() || 'reviewer';
    const notes = document.getElementById('notes').value.trim();
    const resultDiv = document.getElementById('review-result');

    const data = {
        reviewer: reviewer,
        notes: notes || 'Acknowledged via detail page'
    };

    try {
        const response = await fetch('{{ url_for("abx_indications.acknowledge_candidate", candidate_id=candidate.id) }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
            resultDiv.innerHTML = '<div class="alert alert-success">Acknowledged! Returning to dashboard...</div>';
            resultDiv.classList.remove('hidden');
            setTimeout(() => window.location.href = '{{ url_for("abx_indications.dashboard") }}', 1000);
        } else {
            resultDiv.innerHTML = '<div class="alert alert-danger">Error: ' + result.error + '</div>';
            resultDiv.classList.remove('hidden');
        }
    } catch (err) {
        resultDiv.innerHTML = '<div class="alert alert-danger">Failed: ' + err.message + '</div>';
        resultDiv.classList.remove('hidden');
    }
}
</script>

<style>
.candidate-status-bar {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.status-source {
    color: var(--color-gray-500);
    font-size: 0.875rem;
}

.badge-lg {
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
}

/* Classification badges */
.badge-classification-A { background: var(--color-success); color: white; }
.badge-classification-FN { background: var(--color-success); color: white; }
.badge-classification-S { background: var(--color-warning); color: var(--color-gray-900); }
.badge-classification-N { background: var(--color-danger); color: white; }
.badge-classification-P { background: var(--color-primary); color: white; }
.badge-classification-U { background: var(--color-gray-400); color: white; }

.classification-summary {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.primary-indication {
    font-weight: 500;
    color: var(--color-gray-700);
}

.icd10-codes {
    margin-top: 1rem;
}

.code-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    list-style: none;
    padding: 0;
    margin: 0.5rem 0 0 0;
}

.code-list li code {
    background: var(--color-gray-100);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.875rem;
}

/* Extraction details */
.extraction-details {
    margin-top: 1rem;
}

.extraction-section {
    margin-bottom: 1rem;
    padding: 1rem;
    background: var(--color-gray-50);
    border-radius: 8px;
}

.extraction-section ul {
    margin: 0.5rem 0 0 1.5rem;
    padding: 0;
}

.supporting-quotes {
    border-left: 3px solid var(--color-primary);
}

.supporting-quotes .quote {
    font-style: italic;
    color: var(--color-gray-600);
    margin-bottom: 0.5rem;
}

.extraction-meta {
    display: flex;
    gap: 1.5rem;
    font-size: 0.8rem;
    color: var(--color-gray-500);
    margin-top: 1rem;
    padding-top: 0.5rem;
    border-top: 1px solid var(--color-gray-200);
}

/* Comparison table */
.comparison-table {
    width: 100%;
    border-collapse: collapse;
}

.comparison-table th,
.comparison-table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid var(--color-gray-200);
}

.comparison-table th {
    background: var(--color-gray-50);
    font-weight: 600;
}

.comparison-table .final-row {
    background: var(--color-gray-50);
}

/* Review history */
.review-item {
    padding: 1rem;
    background: var(--color-gray-50);
    border-radius: 8px;
    margin-bottom: 0.75rem;
}

.review-item.review-override {
    border-left: 4px solid var(--color-warning);
}

.review-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.5rem;
}

.reviewer {
    font-weight: 600;
}

.review-date {
    color: var(--color-gray-500);
    font-size: 0.8rem;
}

.review-decision,
.override-reason,
.review-notes {
    margin-top: 0.5rem;
    font-size: 0.875rem;
}

/* Action buttons */
.confirm-buttons,
.override-buttons {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.override-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem;
}

.btn-appropriate {
    background: var(--color-success);
    color: white;
    border: 2px solid var(--color-success);
    padding: 1rem;
    font-weight: 600;
}

.btn-appropriate:hover { background: #15803d; }

.btn-sometimes {
    background: var(--color-warning);
    color: var(--color-gray-900);
    border: 2px solid var(--color-warning);
    padding: 1rem;
    font-weight: 600;
}

.btn-inappropriate {
    background: var(--color-danger);
    color: white;
    border: 2px solid var(--color-danger);
    padding: 1rem;
    font-weight: 600;
}

.btn-inappropriate:hover { background: #b91c1c; }

.btn-override-appropriate {
    background: white;
    color: var(--color-success);
    border: 2px solid var(--color-success);
    padding: 0.75rem;
    font-weight: 500;
}

.btn-override-appropriate:hover { background: var(--color-success); color: white; }

.btn-override-sometimes {
    background: white;
    color: var(--color-warning);
    border: 2px solid var(--color-warning);
    padding: 0.75rem;
    font-weight: 500;
}

.btn-override-sometimes:hover { background: var(--color-warning); }

.btn-override-inappropriate {
    background: white;
    color: var(--color-danger);
    border: 2px solid var(--color-danger);
    padding: 0.75rem;
    font-weight: 500;
}

.btn-override-inappropriate:hover { background: var(--color-danger); color: white; }

.btn-override-prophylaxis {
    background: white;
    color: var(--color-primary);
    border: 2px solid var(--color-primary);
    padding: 0.75rem;
    font-weight: 500;
}

.btn-override-prophylaxis:hover { background: var(--color-primary); color: white; }

.confirm-buttons button.selected,
.override-buttons button.selected {
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
}

.classification-divider {
    margin: 1.25rem 0;
    text-align: center;
    color: var(--color-gray-500);
    font-size: 0.8rem;
    position: relative;
}

.classification-divider::before,
.classification-divider::after {
    content: '';
    position: absolute;
    top: 50%;
    width: 20%;
    height: 1px;
    background: var(--color-gray-300);
}

.classification-divider::before { left: 0; }
.classification-divider::after { right: 0; }

.form-help {
    font-size: 0.75rem;
    color: var(--color-gray-500);
    margin-top: 0.5rem;
}

/* Form controls */
.form-control {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--color-gray-300);
    border-radius: 6px;
    font-size: 1rem;
}

.form-control:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-textarea {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--color-gray-300);
    border-radius: 6px;
    font-size: 0.875rem;
    resize: vertical;
    font-family: inherit;
}

.form-textarea:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

/* Alerts */
.alert {
    padding: 1rem;
    border-radius: 8px;
    margin-top: 1rem;
}

.alert-danger {
    background: #fef2f2;
    border: 1px solid #ef4444;
    color: #991b1b;
}

.alert-success {
    background: #f0fdf4;
    border: 1px solid #10b981;
    color: #065f46;
}

.hidden {
    display: none !important;
}

/* Review complete state */
.review-complete {
    text-align: center;
    padding: 1.5rem;
}

.review-complete .status-icon {
    font-size: 2rem;
    color: var(--color-success);
    display: block;
    margin-bottom: 0.5rem;
}

.resolved-card {
    background: var(--color-gray-50);
}
</style>

{% endblock %}
