{% extends "base.html" %}

{% block title %}HAI Detection Help - {{ app_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>HAI Detection - Demo & Help</h1>
    <a href="{{ url_for('hai_detection.dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
</div>

<div class="help-content">
    <div class="help-card">
        <h2>Overview</h2>
        <p>The NHSN HAI Reporting module assists Infection Preventionists in identifying and classifying
           Healthcare-Associated Infections (HAIs) for NHSN reporting. Currently supported:</p>
        <ul>
            <li><strong>CLABSI</strong> - Central Line-Associated Bloodstream Infections</li>
            <li><strong>CAUTI</strong> - Catheter-Associated Urinary Tract Infections</li>
            <li><strong>SSI</strong> - Surgical Site Infections (Superficial, Deep, Organ/Space)</li>
            <li><strong>VAE</strong> - Ventilator-Associated Events (VAC, IVAC, Possible/Probable VAP)</li>
            <li><strong>CDI</strong> - Clostridioides difficile Infections (HO-CDI, CO-CDI, CO-HCFA)</li>
        </ul>
        <p>The system uses a four-stage workflow:</p>
        <ol>
            <li><strong>Rule-based screening</strong> - Identifies candidates (BSI + line for CLABSI; catheter + positive urine for CAUTI; procedure + infection signals for SSI; ventilator worsening for VAE; positive C. diff test for CDI)</li>
            <li><strong>LLM fact extraction</strong> - Extracts clinical facts from notes (symptoms, alternate sources, wound assessments)</li>
            <li><strong>Rules engine</strong> - Applies deterministic NHSN criteria to extracted facts</li>
            <li><strong>IP Review</strong> - <strong>ALL candidates</strong> go to IP for final decision</li>
        </ol>
        <p><strong>Key principle:</strong> The LLM extracts facts and provides a preliminary classification with confidence score,
           but the Infection Preventionist always makes the final determination. This ensures human oversight on all HAI decisions.</p>
    </div>

    <div class="help-card">
        <h2>Quick Start - Generate Demo Data</h2>

        <h3>Create CLABSI Candidates</h3>
        <p>Generate demo patients with CLABSI scenarios for testing:</p>
        <pre><code># Create one CLABSI + one Not CLABSI (random type)
cd /home/david/projects/aegis
python scripts/demo_clabsi.py

# Create all scenario types
python scripts/demo_clabsi.py --all

# Create a specific scenario
python scripts/demo_clabsi.py --scenario clabsi
python scripts/demo_clabsi.py --scenario mbi
python scripts/demo_clabsi.py --scenario secondary-uti
python scripts/demo_clabsi.py --scenario secondary-pneumonia</code></pre>

        <h3>Create CAUTI Candidates</h3>
        <p>Generate demo patients with CAUTI (Catheter-Associated UTI) scenarios:</p>
        <pre><code># Create one CAUTI + one Not CAUTI (random type)
cd /home/david/projects/aegis
python scripts/demo_cauti.py

# Create all scenario types
python scripts/demo_cauti.py --all

# Create a specific scenario
python scripts/demo_cauti.py --scenario cauti
python scripts/demo_cauti.py --scenario asymptomatic-bacteriuria
python scripts/demo_cauti.py --scenario not-cauti</code></pre>

        <h3>Create SSI Candidates</h3>
        <p>Generate demo patients with SSI (Surgical Site Infection) scenarios:</p>
        <pre><code># Create one SSI + one Not SSI (random type)
cd /home/david/projects/aegis
python scripts/demo_ssi.py

# Create all scenario types
python scripts/demo_ssi.py --all

# Create a specific scenario
python scripts/demo_ssi.py --scenario superficial
python scripts/demo_ssi.py --scenario deep
python scripts/demo_ssi.py --scenario organ-space
python scripts/demo_ssi.py --scenario not-ssi</code></pre>

        <h3>Create CDI Candidates</h3>
        <p>Generate demo patients with CDI (C. difficile Infection) scenarios:</p>
        <pre><code># Create one CDI + one Not CDI (random type)
cd /home/david/projects/aegis
python scripts/demo_cdi.py

# Create all scenario types
python scripts/demo_cdi.py --all

# Create a specific scenario
python scripts/demo_cdi.py --scenario ho-cdi
python scripts/demo_cdi.py --scenario co-cdi
python scripts/demo_cdi.py --scenario co-hcfa
python scripts/demo_cdi.py --scenario recurrent
python scripts/demo_cdi.py --scenario not-cdi</code></pre>

        <h3>Run the Full Pipeline</h3>
        <p>After creating demo data, run the HAI monitor to detect and classify candidates:</p>
        <pre><code>cd /home/david/projects/aegis/hai-detection
python -m src.runner --full</code></pre>

        <p>This will:</p>
        <ol>
            <li>Detect new CLABSI candidates from FHIR</li>
            <li>Run LLM extraction and rules engine classification</li>
            <li>Create review entries in the IP Review Queue</li>
        </ol>

        <p>Then go to the <a href="{{ url_for('hai_detection.dashboard') }}">Dashboard</a> to review and make final decisions on the new cases.</p>
    </div>

    <div class="help-card">
        <h2>CLABSI Demo Scenarios</h2>
        <table class="help-table">
            <thead>
                <tr>
                    <th>Scenario</th>
                    <th>Command</th>
                    <th>Organism</th>
                    <th>Key Evidence</th>
                    <th>Classification</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Clear CLABSI</strong></td>
                    <td><code>--scenario clabsi</code></td>
                    <td>S. aureus</td>
                    <td>Line site infection, negative UA, clear CXR</td>
                    <td><span class="badge badge-critical">CLABSI</span></td>
                </tr>
                <tr>
                    <td><strong>MBI-LCBI</strong></td>
                    <td><code>--scenario mbi</code></td>
                    <td>E. coli</td>
                    <td>BMT patient, ANC 0, Grade 3 mucositis</td>
                    <td><span class="badge badge-warning">Not CLABSI - MBI</span></td>
                </tr>
                <tr>
                    <td><strong>Secondary (UTI)</strong></td>
                    <td><code>--scenario secondary-uti</code></td>
                    <td>E. coli</td>
                    <td>Same organism in blood + urine, pyelonephritis on CT</td>
                    <td><span class="badge badge-info">Not CLABSI - Secondary</span></td>
                </tr>
                <tr>
                    <td><strong>Secondary (PNA)</strong></td>
                    <td><code>--scenario secondary-pneumonia</code></td>
                    <td>Pseudomonas</td>
                    <td>Same organism in blood + respiratory, VAP on CXR</td>
                    <td><span class="badge badge-info">Not CLABSI - Secondary</span></td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="help-card">
        <h2>CAUTI Demo Scenarios</h2>
        <p>CAUTI (Catheter-Associated Urinary Tract Infection) detection follows NHSN criteria requiring catheter >2 days, positive culture, and qualifying symptoms:</p>
        <table class="help-table">
            <thead>
                <tr>
                    <th>Scenario</th>
                    <th>Command</th>
                    <th>Catheter Days</th>
                    <th>Key Evidence</th>
                    <th>Classification</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Clear CAUTI</strong></td>
                    <td><code>--scenario cauti</code></td>
                    <td>5 days</td>
                    <td>E. coli 10^5 CFU/mL, fever 38.5°C, dysuria</td>
                    <td><span class="badge badge-critical">CAUTI</span></td>
                </tr>
                <tr>
                    <td><strong>CAUTI (Fever Only, Young)</strong></td>
                    <td><code>--scenario cauti-fever</code></td>
                    <td>4 days</td>
                    <td>Klebsiella 10^5 CFU/mL, fever 38.8°C (patient age 50)</td>
                    <td><span class="badge badge-critical">CAUTI</span></td>
                </tr>
                <tr>
                    <td><strong>Asymptomatic Bacteriuria</strong></td>
                    <td><code>--scenario asb</code></td>
                    <td>5 days</td>
                    <td>Positive culture, no symptoms documented</td>
                    <td><span class="badge badge-warning">Asymptomatic Bacteriuria</span></td>
                </tr>
                <tr>
                    <td><strong>Fever Only (Elderly)</strong></td>
                    <td><code>--scenario fever-elderly</code></td>
                    <td>2 days</td>
                    <td>Fever 38.5°C, patient age 75, catheter ≤2 days</td>
                    <td><span class="badge badge-info">Not CAUTI (Age Rule)</span></td>
                </tr>
                <tr>
                    <td><strong>Not Eligible (Mixed Flora)</strong></td>
                    <td><code>--scenario mixed-flora</code></td>
                    <td>5 days</td>
                    <td>&gt;2 organisms (mixed flora culture)</td>
                    <td><span class="badge badge-success">Not Eligible</span></td>
                </tr>
                <tr>
                    <td><strong>Not Eligible (Candida)</strong></td>
                    <td><code>--scenario candida</code></td>
                    <td>5 days</td>
                    <td>Candida albicans only (yeast excluded)</td>
                    <td><span class="badge badge-success">Not Eligible</span></td>
                </tr>
            </tbody>
        </table>
        <p><em>Note: The age-based fever rule requires patients &gt;65 years to have catheter &gt;2 days for fever alone to qualify as a CAUTI symptom.</em></p>
    </div>

    <div class="help-card">
        <h2>SSI Demo Scenarios</h2>
        <table class="help-table">
            <thead>
                <tr>
                    <th>Scenario</th>
                    <th>Command</th>
                    <th>Procedure</th>
                    <th>Key Evidence</th>
                    <th>Classification</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Superficial SSI</strong></td>
                    <td><code>--scenario superficial</code></td>
                    <td>Cholecystectomy</td>
                    <td>Purulent drainage, erythema, positive wound culture</td>
                    <td><span class="badge badge-warning">Superficial SSI</span></td>
                </tr>
                <tr>
                    <td><strong>Deep SSI</strong></td>
                    <td><code>--scenario deep</code></td>
                    <td>Colectomy</td>
                    <td>Fascial dehiscence, fever &gt;38C, deep tissue involved</td>
                    <td><span class="badge badge-critical">Deep SSI</span></td>
                </tr>
                <tr>
                    <td><strong>Organ/Space SSI</strong></td>
                    <td><code>--scenario organ-space</code></td>
                    <td>Colectomy</td>
                    <td>Pelvic abscess on CT, positive drain culture</td>
                    <td><span class="badge badge-critical">Organ/Space SSI</span></td>
                </tr>
                <tr>
                    <td><strong>Not SSI</strong></td>
                    <td><code>--scenario not-ssi</code></td>
                    <td>Total Knee</td>
                    <td>Wound healing well, no infection signs</td>
                    <td><span class="badge badge-success">Not SSI</span></td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="help-card">
        <h2>VAE Demo Scenarios</h2>
        <p>VAE (Ventilator-Associated Event) detection follows the NHSN tiered classification hierarchy:</p>
        <table class="help-table">
            <thead>
                <tr>
                    <th>Scenario</th>
                    <th>Command</th>
                    <th>Ventilator Days</th>
                    <th>Key Evidence</th>
                    <th>Classification</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>VAC Only</strong></td>
                    <td><code>--scenario vac</code></td>
                    <td>Day 5</td>
                    <td>FiO2 +25%, no fever, no antibiotics</td>
                    <td><span class="badge badge-info">VAC (Tier 1)</span></td>
                </tr>
                <tr>
                    <td><strong>IVAC</strong></td>
                    <td><code>--scenario ivac</code></td>
                    <td>Day 7</td>
                    <td>PEEP +4 cmH2O, fever 38.8°C, vancomycin x5 days</td>
                    <td><span class="badge badge-warning">IVAC (Tier 2)</span></td>
                </tr>
                <tr>
                    <td><strong>Possible VAP</strong></td>
                    <td><code>--scenario possible-vap</code></td>
                    <td>Day 8</td>
                    <td>IVAC criteria + positive sputum culture</td>
                    <td><span class="badge badge-critical">Possible VAP (Tier 3)</span></td>
                </tr>
                <tr>
                    <td><strong>Probable VAP</strong></td>
                    <td><code>--scenario probable-vap</code></td>
                    <td>Day 10</td>
                    <td>IVAC criteria + purulent secretions + BAL 10^5 CFU/mL</td>
                    <td><span class="badge badge-critical">Probable VAP (Tier 3)</span></td>
                </tr>
                <tr>
                    <td><strong>Not VAE</strong></td>
                    <td><code>--scenario not-vae</code></td>
                    <td>Day 3</td>
                    <td>Stable ventilator settings, no worsening</td>
                    <td><span class="badge badge-success">Not VAE</span></td>
                </tr>
            </tbody>
        </table>
        <p><em>Note: VAE detection requires access to ventilator parameter data (FiO2/PEEP) from the EHR.</em></p>
    </div>

    <div class="help-card">
        <h2>CDI Demo Scenarios</h2>
        <p>CDI (Clostridioides difficile Infection) detection follows NHSN LabID Event criteria with time-based onset classification:</p>
        <table class="help-table">
            <thead>
                <tr>
                    <th>Scenario</th>
                    <th>Command</th>
                    <th>Specimen Day</th>
                    <th>Key Evidence</th>
                    <th>Classification</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>HO-CDI</strong></td>
                    <td><code>--scenario ho-cdi</code></td>
                    <td>Day 5</td>
                    <td>Positive toxin A/B, unformed stool, >3 days after admission</td>
                    <td><span class="badge badge-critical">HO-CDI</span></td>
                </tr>
                <tr>
                    <td><strong>CO-CDI</strong></td>
                    <td><code>--scenario co-cdi</code></td>
                    <td>Day 2</td>
                    <td>Positive toxin A/B, unformed stool, ≤3 days after admission</td>
                    <td><span class="badge badge-warning">CO-CDI</span></td>
                </tr>
                <tr>
                    <td><strong>CO-HCFA</strong></td>
                    <td><code>--scenario co-hcfa</code></td>
                    <td>Day 2</td>
                    <td>CO-CDI + discharged from facility within prior 4 weeks</td>
                    <td><span class="badge badge-warning">CO-HCFA</span></td>
                </tr>
                <tr>
                    <td><strong>Recurrent CDI</strong></td>
                    <td><code>--scenario recurrent</code></td>
                    <td>Day 5</td>
                    <td>Positive test 30 days after prior CDI episode</td>
                    <td><span class="badge badge-critical">Recurrent HO-CDI</span></td>
                </tr>
                <tr>
                    <td><strong>Duplicate (Not Reported)</strong></td>
                    <td><code>--scenario duplicate</code></td>
                    <td>Day 3</td>
                    <td>Positive test 10 days after prior CDI (within 14-day window)</td>
                    <td><span class="badge badge-info">Duplicate</span></td>
                </tr>
                <tr>
                    <td><strong>Not CDI (GDH Only)</strong></td>
                    <td><code>--scenario gdh-only</code></td>
                    <td>Day 4</td>
                    <td>GDH antigen positive, toxin negative (does not qualify)</td>
                    <td><span class="badge badge-success">Not CDI</span></td>
                </tr>
            </tbody>
        </table>
        <p><em>Note: CDI classification is time-based. Day 1 = admission date. HO-CDI = specimen day >3. CO-CDI = specimen day ≤3.</em></p>
    </div>

    <div class="help-card">
        <h2>IP Review Decisions</h2>
        <p>When reviewing a CLABSI candidate, you (the Infection Preventionist) make the final determination.
           The LLM classification and confidence score are shown as decision support, but you always have the final say.</p>

        <div class="decision-grid">
            <div class="decision-item decision-clabsi">
                <h4>Confirmed HAI (CLABSI)</h4>
                <p>Confirmed central line-associated bloodstream infection. Use when:</p>
                <ul>
                    <li>Central line in place &gt;2 calendar days</li>
                    <li>No alternative source for the BSI</li>
                    <li>Pathogenic organism OR 2+ positive cultures for skin contaminant</li>
                </ul>
                <p><em>Will be counted as CLABSI and available for NHSN submission.</em></p>
            </div>

            <div class="decision-item decision-not-clabsi">
                <h4>Confirmed Not HAI</h4>
                <p>The BSI is not a CLABSI. Use when:</p>
                <ul>
                    <li>Clear alternative source identified (UTI, pneumonia, etc.)</li>
                    <li>Single culture for skin contaminant (likely contamination)</li>
                    <li>Does not meet NHSN CLABSI criteria</li>
                </ul>
                <p><em>Case will be closed and not reported to NHSN.</em></p>
            </div>

            <div class="decision-item decision-mbi">
                <h4>MBI-LCBI</h4>
                <p>Mucosal Barrier Injury Laboratory-Confirmed Bloodstream Infection. Use when ALL criteria met:</p>
                <ul>
                    <li>Neutropenia (ANC &lt;500) OR allogeneic HSCT with Grade 3-4 GI GVHD</li>
                    <li>Eligible MBI organism (gut flora: E. coli, Klebsiella, Enterococcus, Candida, etc.)</li>
                    <li>Mucosal barrier injury present (mucositis, GVHD)</li>
                </ul>
                <p><em>MBI-LCBI is counted separately from CLABSI for NHSN reporting.</em></p>
            </div>

            <div class="decision-item decision-secondary">
                <h4>Secondary</h4>
                <p>BSI is secondary to another primary infection. Use when:</p>
                <ul>
                    <li>Same organism isolated from another site (urine, respiratory, wound)</li>
                    <li>Clinical presentation consistent with primary infection at other site</li>
                    <li>BSI developed after or concurrent with other site infection</li>
                </ul>
                <p><em>Common sources: UTI, pneumonia, intra-abdominal infection, skin/soft tissue</em></p>
            </div>

            <div class="decision-item decision-needs-info">
                <h4>Needs More Info</h4>
                <p>Additional review or information needed. Use when:</p>
                <ul>
                    <li>Clinical notes are incomplete</li>
                    <li>Need to review additional cultures or imaging</li>
                    <li>Want to discuss with ID or primary team</li>
                </ul>
                <p><em>Candidate stays in the review queue for follow-up. When you later submit a final decision
                   (Confirmed or Not HAI), any prior "Needs More Info" reviews are automatically superseded.</em></p>
            </div>
        </div>
    </div>

    <div class="help-card">
        <h2>NHSN CLABSI Criteria Quick Reference</h2>

        <h3>Inclusion Criteria</h3>
        <ul>
            <li>Patient has a central line at time of BSI OR within 1 calendar day of line removal</li>
            <li>Central line was in place for &gt;2 calendar days on the date of event</li>
            <li>Patient has a laboratory-confirmed bloodstream infection (LCBI)</li>
            <li>BSI is not secondary to an infection at another site</li>
        </ul>

        <h3>LCBI Criteria</h3>
        <p><strong>Criterion 1 (Pathogen):</strong> Recognized pathogen identified from blood culture not related to infection at another site</p>
        <p><strong>Criterion 2 (Contaminant):</strong> Common skin contaminant (e.g., CoNS, Corynebacterium) identified from 2+ blood cultures drawn on separate occasions, PLUS patient has fever (&gt;38.0°C), chills, or hypotension</p>

        <h3>Exclusion: Secondary BSI</h3>
        <p>A BSI is considered secondary if the same organism is isolated from another site AND:</p>
        <ul>
            <li>The other site infection meets NHSN site-specific criteria, OR</li>
            <li>The clinical presentation is consistent with infection at the other site</li>
        </ul>
    </div>

    <div class="help-card">
        <h2>NHSN SSI Criteria Quick Reference</h2>

        <h3>Surveillance Window</h3>
        <ul>
            <li><strong>30 days</strong> - Standard for most procedures</li>
            <li><strong>90 days</strong> - Procedures with implants (prosthetics, hardware)</li>
        </ul>

        <h3>Wound Classification</h3>
        <ul>
            <li><strong>Class 1 (Clean)</strong> - No inflammation, no break in technique, respiratory/GI/GU not entered</li>
            <li><strong>Class 2 (Clean-Contaminated)</strong> - Controlled entry into GI/GU/respiratory tract</li>
            <li><strong>Class 3 (Contaminated)</strong> - Acute inflammation, gross spillage from GI tract</li>
            <li><strong>Class 4 (Dirty-Infected)</strong> - Old traumatic wound, existing infection</li>
        </ul>

        <h3>Superficial Incisional SSI (any one)</h3>
        <ul>
            <li>Purulent drainage from superficial incision</li>
            <li>Organisms from aseptically-obtained culture from superficial incision</li>
            <li>Signs (pain, swelling, erythema, heat) + incision opened by surgeon (unless culture-negative)</li>
            <li>Physician diagnosis of superficial incisional SSI</li>
        </ul>

        <h3>Deep Incisional SSI (any one)</h3>
        <ul>
            <li>Purulent drainage from deep incision (but not organ/space)</li>
            <li>Deep incision spontaneously dehisces OR deliberately opened AND fever (&gt;38°C) or pain</li>
            <li>Abscess in deep incision found on exam, reoperation, imaging, or histopath</li>
            <li>Physician diagnosis of deep incisional SSI</li>
        </ul>

        <h3>Organ/Space SSI (any one)</h3>
        <ul>
            <li>Purulent drainage from drain placed in organ/space</li>
            <li>Organisms from culture of fluid/tissue from organ/space</li>
            <li>Abscess in organ/space found on exam, reoperation, imaging, or histopath</li>
            <li>Physician diagnosis of organ/space SSI</li>
        </ul>

        <h3>Common Organ/Space Sites</h3>
        <p>NHSN codes: IAB (intra-abdominal), MED (mediastinitis), BONE (osteomyelitis), DISC (disc space), JNT (joint), MEN (meningitis)</p>
    </div>

    <div class="help-card">
        <h2>NHSN CAUTI Criteria Quick Reference</h2>

        <h3>Inclusion Criteria</h3>
        <ul>
            <li>Indwelling urinary catheter (IUC) in place for &gt;2 calendar days on date of event</li>
            <li>IUC was in place on the date of event OR removed the day before</li>
            <li>Patient has a positive urine culture meeting criteria</li>
            <li>Patient has at least one qualifying symptom (not asymptomatic bacteriuria)</li>
        </ul>

        <h3>Culture Criteria</h3>
        <ul>
            <li><strong>CFU/mL</strong>: ≥10⁵ CFU/mL (100,000 colony-forming units per mL)</li>
            <li><strong>Organism count</strong>: ≤2 organisms identified (no mixed flora)</li>
            <li><strong>Excluded organisms</strong>: Candida species, yeast, and other fungi</li>
        </ul>

        <h3>Qualifying Symptoms (at least one)</h3>
        <ul>
            <li><strong>Fever</strong>: Temperature &gt;38.0°C (100.4°F)</li>
            <li><strong>Suprapubic tenderness</strong>: Pain/tenderness over the bladder</li>
            <li><strong>CVA pain/tenderness</strong>: Costovertebral angle (flank) tenderness</li>
            <li><strong>Urinary urgency</strong>: Sudden compelling need to urinate</li>
            <li><strong>Urinary frequency</strong>: Increased frequency of urination</li>
            <li><strong>Dysuria</strong>: Pain or burning with urination</li>
        </ul>

        <h3>Age-Based Fever Rule</h3>
        <p>Special consideration for fever as the only symptom:</p>
        <ul>
            <li><strong>Patient ≤65 years</strong>: Fever alone qualifies as a CAUTI symptom</li>
            <li><strong>Patient &gt;65 years</strong>: Fever alone requires catheter &gt;2 days; otherwise, another symptom must be present</li>
        </ul>
        <p><em>This rule helps distinguish CAUTI from other causes of fever in elderly catheterized patients.</em></p>

        <h3>Asymptomatic Bacteriuria</h3>
        <p>If catheter and culture criteria are met but NO symptoms are documented, the case is classified as:</p>
        <ul>
            <li><strong>Asymptomatic bacteriuria (ASB)</strong> - Not reported as CAUTI</li>
            <li>ASB cases require IP review to confirm no symptoms were missed in documentation</li>
            <li>ASB is common in catheterized patients and should not be treated unless symptomatic</li>
        </ul>

        <h3>Common Uropathogens</h3>
        <p>Organisms typically associated with CAUTI:</p>
        <ul>
            <li>Escherichia coli (most common)</li>
            <li>Klebsiella pneumoniae</li>
            <li>Enterococcus faecalis</li>
            <li>Pseudomonas aeruginosa</li>
            <li>Proteus mirabilis</li>
            <li>Enterobacter species</li>
        </ul>
    </div>

    <div class="help-card">
        <h2>NHSN VAE Criteria Quick Reference</h2>

        <h3>VAE Hierarchy (NHSN Tiers)</h3>
        <p>VAE classifications are hierarchical - higher tiers include all criteria from lower tiers:</p>
        <table class="help-table">
            <thead>
                <tr>
                    <th>Classification</th>
                    <th>Tier</th>
                    <th>Requires</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>VAC</strong> (Ventilator-Associated Condition)</td>
                    <td>1</td>
                    <td>Baseline period + sustained worsening</td>
                </tr>
                <tr>
                    <td><strong>IVAC</strong> (Infection-related VAC)</td>
                    <td>2</td>
                    <td>VAC + temperature/WBC + antimicrobials</td>
                </tr>
                <tr>
                    <td><strong>Possible VAP</strong></td>
                    <td>3</td>
                    <td>IVAC + purulent secretions OR positive culture</td>
                </tr>
                <tr>
                    <td><strong>Probable VAP</strong></td>
                    <td>3</td>
                    <td>IVAC + purulent secretions + quantitative culture</td>
                </tr>
            </tbody>
        </table>

        <h3>VAC Criteria</h3>
        <p><strong>Baseline Period (≥2 calendar days):</strong></p>
        <ul>
            <li>Patient on mechanical ventilation</li>
            <li>Stable or decreasing daily minimum FiO2 or PEEP</li>
        </ul>
        <p><strong>Worsening Period (≥2 calendar days after baseline):</strong></p>
        <ul>
            <li>Daily minimum FiO2 increased ≥20 percentage points over baseline minimum, OR</li>
            <li>Daily minimum PEEP increased ≥3 cmH2O over baseline minimum</li>
        </ul>
        <p><em>VAC onset date = first day of the worsening period</em></p>

        <h3>IVAC Criteria (VAC + all of the following)</h3>
        <ul>
            <li><strong>Temperature</strong>: &gt;38°C or &lt;36°C</li>
            <li><strong>WBC</strong>: ≥12,000 cells/mm³ or ≤4,000 cells/mm³</li>
            <li><strong>Antimicrobials</strong>: New qualifying antimicrobial started within ±2 calendar days of VAC onset AND continued for ≥4 calendar days</li>
        </ul>

        <h3>Possible VAP Criteria (IVAC + one of the following)</h3>
        <ul>
            <li><strong>Purulent secretions</strong>: ≥25 neutrophils and ≤10 squamous epithelial cells per low power field</li>
            <li><strong>Positive culture</strong>: Positive respiratory culture (any growth)</li>
        </ul>

        <h3>Probable VAP Criteria (IVAC + both of the following)</h3>
        <ul>
            <li><strong>Purulent secretions</strong>: As defined above</li>
            <li><strong>Quantitative culture</strong> meeting threshold:
                <ul>
                    <li>BAL (bronchoalveolar lavage): ≥10⁴ CFU/mL</li>
                    <li>Lung tissue: ≥10⁴ CFU/g</li>
                    <li>PSB (protected specimen brush): ≥10³ CFU/mL</li>
                    <li>ETA (endotracheal aspirate): ≥10⁶ CFU/mL</li>
                </ul>
            </li>
        </ul>

        <h3>Qualifying Antimicrobials for IVAC</h3>
        <p>Includes most IV/PO antibiotics used for respiratory infections:</p>
        <ul>
            <li>Beta-lactams (piperacillin-tazobactam, ceftriaxone, cefepime, meropenem, etc.)</li>
            <li>Fluoroquinolones (ciprofloxacin, levofloxacin, moxifloxacin)</li>
            <li>Aminoglycosides (gentamicin, tobramycin, amikacin)</li>
            <li>Glycopeptides (vancomycin)</li>
            <li>Oxazolidinones (linezolid)</li>
        </ul>
        <p><em>Excludes: Topical agents, antifungals, antivirals</em></p>
    </div>

    <div class="help-card">
        <h2>NHSN CDI Criteria Quick Reference</h2>

        <h3>CDI LabID Event Definition</h3>
        <p>A positive laboratory test result for:</p>
        <ul>
            <li>C. difficile toxin A and/or B, OR</li>
            <li>Toxin-producing C. difficile by culture or PCR/NAAT</li>
        </ul>
        <p>On an <strong>unformed stool specimen</strong> (including ostomy collections).</p>
        <p><strong>Important:</strong> GDH (glutamate dehydrogenase) antigen-only results do NOT qualify as a LabID event.</p>

        <h3>Onset Classification</h3>
        <table class="help-table">
            <thead>
                <tr>
                    <th>Classification</th>
                    <th>Specimen Day</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>HO-CDI</strong></td>
                    <td>Day 4+ (&gt;3 days)</td>
                    <td>Healthcare-Facility-Onset: Specimen collected &gt;3 days after admission</td>
                </tr>
                <tr>
                    <td><strong>CO-CDI</strong></td>
                    <td>Days 1-3 (≤3 days)</td>
                    <td>Community-Onset: Specimen collected ≤3 days after admission</td>
                </tr>
                <tr>
                    <td><strong>CO-HCFA</strong></td>
                    <td>Days 1-3</td>
                    <td>Community-Onset Healthcare Facility-Associated: CO-CDI with discharge from any facility within prior 4 weeks</td>
                </tr>
            </tbody>
        </table>
        <p><em>Day 1 = facility admission date</em></p>

        <h3>Recurrence Classification</h3>
        <table class="help-table">
            <thead>
                <tr>
                    <th>Days Since Last CDI Event</th>
                    <th>Classification</th>
                    <th>Reporting</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>≤14 days</td>
                    <td>Duplicate</td>
                    <td>Not reported (same episode)</td>
                </tr>
                <tr>
                    <td>15-56 days</td>
                    <td>Recurrent</td>
                    <td>Reported as recurrent CDI</td>
                </tr>
                <tr>
                    <td>&gt;56 days</td>
                    <td>New Incident</td>
                    <td>Reported as new CDI event</td>
                </tr>
            </tbody>
        </table>

        <h3>Test Type Eligibility</h3>
        <p>For multi-step testing algorithms, the <strong>last test performed</strong> determines eligibility:</p>
        <table class="help-table">
            <thead>
                <tr>
                    <th>Test Type</th>
                    <th>Qualifies for LabID Event</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Toxin A/B EIA</td>
                    <td><span class="badge badge-success">Yes</span> (if positive)</td>
                </tr>
                <tr>
                    <td>PCR/NAAT</td>
                    <td><span class="badge badge-success">Yes</span> (if positive)</td>
                </tr>
                <tr>
                    <td>Toxigenic culture</td>
                    <td><span class="badge badge-success">Yes</span> (if positive)</td>
                </tr>
                <tr>
                    <td>GDH antigen only</td>
                    <td><span class="badge badge-critical">No</span></td>
                </tr>
            </tbody>
        </table>

        <h3>Specimen Requirements</h3>
        <ul>
            <li><strong>Unformed stool only</strong>: Specimen must conform to container shape (Bristol stool types 5-7)</li>
            <li><strong>Formed stool excluded</strong>: Solid stool specimens do not qualify</li>
            <li><strong>Ostomy specimens</strong>: Acceptable if stool is unformed</li>
            <li><strong>Rectal swabs</strong>: Generally not acceptable for CDI surveillance</li>
        </ul>

        <h3>Common LOINC Codes for C. diff Testing</h3>
        <ul>
            <li><strong>34713-8</strong>: C. difficile toxin A</li>
            <li><strong>34714-6</strong>: C. difficile toxin B</li>
            <li><strong>34712-0</strong>: C. difficile toxin A+B</li>
            <li><strong>82197-9</strong>: C. difficile toxin B gene (PCR)</li>
            <li><strong>80685-5</strong>: C. difficile toxin genes (NAAT)</li>
        </ul>
    </div>

    <div class="help-card">
        <h2>LLM-Assisted Classification</h2>
        <p>The system uses a two-stage approach: <strong>LLM extraction</strong> followed by <strong>rules engine</strong>.</p>

        <h3>Stage 1: LLM Fact Extraction</h3>
        <p>A local LLM (Ollama llama3.1) reads clinical notes and extracts structured facts:</p>
        <ul>
            <li><strong>Alternate infection sources</strong> - Pneumonia, UTI, SSTI, intra-abdominal</li>
            <li><strong>Symptoms</strong> - Fever, WBC changes, hypotension</li>
            <li><strong>MBI factors</strong> - Neutropenia, mucositis, HSCT status, GVHD</li>
            <li><strong>Line assessment</strong> - Exit site findings, clinical suspicion</li>
            <li><strong>Contamination signals</strong> - Team treating as contaminant</li>
        </ul>
        <p><em>The LLM answers factual questions about documentation - it does NOT make classification decisions.</em></p>

        <h3>Stage 2: Rules Engine</h3>
        <p>Deterministic NHSN criteria are applied to the extracted facts:</p>
        <ol>
            <li>Basic eligibility check (line days, timing)</li>
            <li>MBI-LCBI criteria evaluation</li>
            <li>Secondary BSI check (same organism at other site)</li>
            <li>Contamination check (single commensal culture)</li>
            <li>Default to CLABSI if no exclusions apply</li>
        </ol>

        <h3>IP Makes Final Decision</h3>
        <p>ALL candidates are routed to IP review regardless of confidence score. The LLM classification and confidence
           are displayed as <strong>decision support</strong>, but IP always makes the final determination.</p>

        <p>This approach ensures:</p>
        <ul>
            <li><strong>Human oversight</strong> on all HAI determinations</li>
            <li><strong>Transparency</strong> - Every decision can be traced to specific criteria</li>
            <li><strong>Override tracking</strong> - When IP disagrees with LLM, it's logged for quality assessment</li>
        </ul>

        <p><strong>Privacy:</strong> All PHI stays on-premise. The Ollama LLM runs locally and no data is sent to external services.</p>
    </div>

    <div class="help-card">
        <h2>Troubleshooting</h2>

        <h3>FHIR server not responding</h3>
        <pre><code># Check if container is running
docker ps | grep hapi

# Restart if needed
cd asp-bacteremia-alerts
docker-compose down && docker-compose up -d</code></pre>

        <h3>Clear HAI data and start fresh</h3>
        <pre><code># Clear HAI/NHSN database (shared database)
rm -f ~/.aegis/nhsn.db

# Clear FHIR server data
cd asp-bacteremia-alerts
docker-compose down && docker-compose up -d</code></pre>

        <h3>LLM classification not running</h3>
        <pre><code># Check if Ollama is running
curl http://localhost:11434/api/tags

# If not running, start Ollama
ollama serve</code></pre>

        <h3>Check available Ollama models</h3>
        <pre><code>ollama list</code></pre>
    </div>

    <div class="help-card">
        <h2>Architecture</h2>
        <pre class="architecture-diagram">
+-------------------+     +-------------------+
|   Demo Scripts    |----&gt;|  HAPI FHIR        |
| demo_clabsi.py    |     |  Server :8081     |
| demo_ssi.py       |     |                   |
| demo_vae.py       |     |                   |
| demo_cdi.py       |     |                   |
+-------------------+     +---------+---------+
                                    |
                                    v
                         +-------------------+
                         |  HAI Monitor      |
                         |  (Rule-based      |
                         |   Screening)      |
                         +---------+---------+
                                   |
       +----------+----------+----------+----------+----------+
       |          |          |          |          |          |
+----------+ +----------+ +----------+ +----------+ +----------+
|CLABSI    | |CAUTI     | |SSI       | |VAE       | |CDI       |
|Detector  | |Detector  | |Detector  | |Detector  | |Detector  |
|(BSI+Line)| |(Cath+UCx)| |(Procedure| |(Vent     | |(C.diff   |
+----------+ +----------+ +----------+ +----------+ +----------+
       |          |          |          |          |
       +----------+----------+----------+----------+
                                   |
              +--------------------+--------------------+
              v                                        v
    +-------------------+                    +-------------------+
    |  LLM Extraction   |                    |   Rules Engine    |
    |  (Ollama llama3.1)|---&gt; Facts -------&gt;|  (NHSN Criteria)  |
    +-------------------+                    +---------+---------+
                                                       |
                                                       v
                                             +-------------------+
                                             |   IP Review       |
                                             | (Final Decision)  |
                                             +---------+---------+
                                                       |
                         +-----------------------------+
                         v                             v
               +-------------------+          +-------------------+
               |  Confirmed HAI    |          | Confirmed Not HAI |
               |  (NHSN Events)    |          |    (Rejected)     |
               +-------------------+          +-------------------+
        </pre>
    </div>

    <div class="help-card">
        <h2>Links</h2>
        <ul>
            <li><a href="{{ url_for('hai_detection.dashboard') }}">Dashboard</a> - Active cases awaiting IP review</li>
            <li><a href="{{ url_for('hai_detection.history') }}">History</a> - Completed reviews (confirmed HAI and confirmed not HAI)</li>
            <li><a href="{{ url_for('hai_detection.reports') }}">Reports & Analytics</a> - LLM quality metrics and override tracking</li>
            <li><a href="{{ url_for('hai_detection.submission') }}">NHSN Submission</a> - Export or submit confirmed events to NHSN</li>
            <li><a href="{{ url_for('asp_alerts.help_page') }}">ASP Alerts Help</a> - Help for bacteremia and antimicrobial usage alerts</li>
        </ul>
    </div>
</div>

<style>
.decision-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.decision-item {
    padding: 1rem;
    border-radius: 8px;
    border-left: 4px solid;
}

.decision-item h4 {
    margin: 0 0 0.5rem 0;
    font-size: 1.1rem;
}

.decision-item p {
    margin: 0.5rem 0;
    font-size: 0.9rem;
}

.decision-item ul {
    margin: 0.5rem 0;
    padding-left: 1.2rem;
    font-size: 0.85rem;
}

.decision-item li {
    margin: 0.25rem 0;
}

.decision-clabsi {
    background: #fef2f2;
    border-color: #dc2626;
}

.decision-not-clabsi {
    background: #f0fdf4;
    border-color: #16a34a;
}

.decision-mbi {
    background: #fffbeb;
    border-color: #f59e0b;
}

.decision-secondary {
    background: #f5f3ff;
    border-color: #8b5cf6;
}

.decision-needs-info {
    background: #f8fafc;
    border-color: #6b7280;
}
</style>
{% endblock %}
