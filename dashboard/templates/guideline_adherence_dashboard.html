{% extends "base.html" %}

{% block title %}Guideline Adherence - {{ app_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Guideline Adherence</h1>
    <div class="header-actions">
        <a href="{{ url_for('guideline_adherence.active_episodes') }}" class="btn btn-primary">View Active Episodes</a>
        <a href="{{ url_for('guideline_adherence.compliance_metrics') }}" class="btn btn-secondary">Metrics</a>
        <a href="{{ url_for('guideline_adherence.help_page') }}" class="btn btn-secondary">Help</a>
    </div>
</div>

<!-- Stats Cards -->
<div class="dashboard-summary">
    <div class="summary-card">
        <div class="summary-icon" style="color: var(--color-success);">&#x1F4C8;</div>
        <div class="summary-content">
            {% if metrics and metrics.element_rates %}
                {% set total_rate = namespace(sum=0, count=0) %}
                {% for er in metrics.element_rates %}
                    {% set total_rate.sum = total_rate.sum + er.compliance_rate %}
                    {% set total_rate.count = total_rate.count + 1 %}
                {% endfor %}
                <div class="summary-value">{{ (total_rate.sum / total_rate.count)|round(1) if total_rate.count > 0 else '--' }}%</div>
            {% else %}
                <div class="summary-value">--</div>
            {% endif %}
            <div class="summary-label">Overall Compliance</div>
        </div>
    </div>
    <div class="summary-card">
        <div class="summary-icon" style="color: var(--color-primary);">&#x1F4CB;</div>
        <div class="summary-content">
            <div class="summary-value">{{ bundles|length }}</div>
            <div class="summary-label">Guidelines Tracked</div>
        </div>
    </div>
    <div class="summary-card">
        <div class="summary-icon" style="color: var(--color-warning);">&#x1F50D;</div>
        <div class="summary-content">
            <div class="summary-value">{{ metrics.episode_counts.total if metrics and metrics.episode_counts else '--' }}</div>
            <div class="summary-label">Episodes (30 days)</div>
        </div>
    </div>
    <div class="summary-card">
        <div class="summary-icon" style="color: var(--color-danger);">&#x26A0;</div>
        <div class="summary-content">
            <div class="summary-value">{{ active_episodes|length }}</div>
            <div class="summary-label">Active Monitoring</div>
        </div>
    </div>
</div>

<!-- Bundle Stats -->
{% if bundle_stats %}
<div class="section">
    <h2>Bundle Compliance</h2>
    <div class="guideline-cards">
        {% for bs in bundle_stats %}
        <a href="{{ url_for('guideline_adherence.bundle_detail', bundle_id=bs.bundle_id) }}" class="guideline-card">
            <h4>{{ bs.bundle_name }}</h4>
            <div class="bundle-stat">
                <span class="compliance-badge {% if bs.avg_compliance >= 90 %}success{% elif bs.avg_compliance >= 70 %}warning{% else %}danger{% endif %}">
                    {{ bs.avg_compliance }}%
                </span>
            </div>
            <p>{{ bs.total_episodes }} episodes, {{ bs.active_episodes }} active</p>
            <span class="element-count">{{ bs.element_count }} elements</span>
        </a>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Active Episodes -->
{% if active_episodes %}
<div class="section">
    <h2>Recent Active Episodes</h2>
    <table class="data-table">
        <thead>
            <tr>
                <th>Patient</th>
                <th>Bundle</th>
                <th>Trigger Time</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for ep in active_episodes %}
            <tr>
                <td>
                    <span class="patient-name">{{ ep.patient_name or 'Unknown' }}</span>
                    {% if ep.patient_mrn %}<br><span class="patient-mrn">MRN: {{ ep.patient_mrn }}</span>{% endif %}
                </td>
                <td>{{ ep.bundle_name or ep.bundle_id }}</td>
                <td>{{ ep.trigger_time[:16] if ep.trigger_time else '-' }}</td>
                <td><span class="badge badge-status-{{ ep.status }}">{{ ep.status }}</span></td>
                <td>
                    <a href="{{ url_for('guideline_adherence.episode_detail', episode_id=ep.id) }}" class="btn btn-small">View</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div style="margin-top: 1rem;">
        <a href="{{ url_for('guideline_adherence.active_episodes') }}" class="btn btn-secondary">View All Active Episodes</a>
    </div>
</div>
{% else %}
<div class="section">
    <h2>Active Episodes</h2>
    <div class="empty-state">
        <p>No active episodes currently being monitored.</p>
        <p style="font-size: 0.875rem; color: var(--color-gray-500);">
            Episodes appear here when patients are identified with conditions matching monitored bundles.
        </p>
    </div>
</div>
{% endif %}

<!-- Available Guidelines -->
<div class="section">
    <h2>Available Guidelines</h2>
    <div class="guideline-cards">
        {% for bundle_id, bundle in bundles.items() %}
        <a href="{{ url_for('guideline_adherence.bundle_detail', bundle_id=bundle_id) }}" class="guideline-card">
            <h4>{{ bundle.name }}</h4>
            <p>{{ bundle.description[:80] }}{% if bundle.description|length > 80 %}...{% endif %}</p>
            <span class="element-count">{{ bundle.elements|length }} elements</span>
        </a>
        {% endfor %}
    </div>
</div>

<style>
.header-actions {
    display: flex;
    gap: 0.5rem;
}

.section {
    background: var(--color-white);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    box-shadow: var(--shadow-md);
    margin-bottom: 1.5rem;
}

.section h2 {
    margin-top: 0;
    margin-bottom: 1rem;
    font-size: 1.25rem;
    color: var(--color-gray-800);
}

.dashboard-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.summary-card {
    background: var(--color-white);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    box-shadow: var(--shadow-md);
    display: flex;
    align-items: center;
    gap: 1rem;
}

.summary-icon {
    font-size: 2rem;
}

.summary-value {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--color-gray-800);
}

.summary-label {
    font-size: 0.875rem;
    color: var(--color-gray-600);
}

.guideline-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
}

.guideline-card {
    display: block;
    padding: 1rem;
    border-radius: var(--radius-md);
    background: var(--color-gray-50);
    border-left: 4px solid #7C3AED;
    text-decoration: none;
    color: inherit;
    transition: transform 0.1s, box-shadow 0.1s;
}

.guideline-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.guideline-card h4 {
    margin: 0 0 0.5rem 0;
    font-size: 1rem;
    color: var(--color-gray-800);
}

.guideline-card p {
    margin: 0 0 0.5rem 0;
    font-size: 0.875rem;
    color: var(--color-gray-600);
}

.bundle-stat {
    margin-bottom: 0.5rem;
}

.compliance-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-weight: 600;
    font-size: 0.875rem;
}

.compliance-badge.success {
    background: var(--color-success-light);
    color: var(--color-success);
}

.compliance-badge.warning {
    background: var(--color-warning-light);
    color: var(--color-warning);
}

.compliance-badge.danger {
    background: var(--color-danger-light);
    color: var(--color-danger);
}

.element-count {
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.25rem 0.5rem;
    border-radius: 9999px;
    background: #7C3AED;
    color: white;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th,
.data-table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid var(--color-gray-200);
}

.data-table th {
    font-weight: 600;
    color: var(--color-gray-600);
    font-size: 0.875rem;
}

.patient-name {
    font-weight: 500;
}

.patient-mrn {
    font-size: 0.75rem;
    color: var(--color-gray-500);
}

.badge-status-active {
    background: var(--color-primary-light);
    color: var(--color-primary);
}

.badge-status-complete {
    background: var(--color-success-light);
    color: var(--color-success);
}

.empty-state {
    text-align: center;
    padding: 2rem;
    color: var(--color-gray-500);
}
</style>
{% endblock %}
